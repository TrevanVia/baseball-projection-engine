import { useState, useMemo, useCallback, useEffect, useRef } from "react";
import {
  LineChart, Line, AreaChart, Area, BarChart, Bar,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
  ReferenceLine, Cell, ComposedChart
} from "recharts";
import _ from "lodash";

// Career WAR data from FanGraphs (generated by generate_war_data.py)
let WAR_DATA = {};
import warDataJson from "./war_data.json";
import xwobaDataJson from "./xwoba_data.json";
const XWOBA_DATA = xwobaDataJson.default || xwobaDataJson;

import { inject } from "@vercel/analytics";
inject(); WAR_DATA = warDataJson;
function normalizeN(name) {
  return name.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
    .replace(/[^a-z0-9 ]/g, "") 
    .replace(/\s+/g, " ").trim();
}


function getCareerWAR(playerId, playerName) {
  const d = WAR_DATA[String(playerId)];
  if (d) return d.careerWAR;
  if (playerName) {
    const normName = normalizeN(playerName);
    const entry = Object.values(WAR_DATA).find(v => normalizeN(v.name) === normName);
    if (entry) return entry.careerWAR;
  }
  return null;
}



// ── MLB STATS API ────────────────────────────────────────────────────────────
const API = "https://statsapi.mlb.com/api/v1";
const SPORT_IDS = { MLB: 1, AAA: 11, AA: 12, "A+": 13, A: 14, ROK: 16 };
const LEVEL_NAMES = { 1: "MLB", 11: "AAA", 12: "AA", 13: "A+", 14: "A", 16: "ROK" };
const LEVEL_ORDER = ["ROK", "A", "A+", "AA", "AAA", "MLB"];

// Translation factors: how MiLB stats convert to MLB equivalents
const LEVEL_TRANSLATION = {
  ROK: { factor: 0.40, wrcAdj: -35, reliability: 0.15, label: "Rookie" },
  A:   { factor: 0.50, wrcAdj: -25, reliability: 0.25, label: "Single-A" },
  "A+":{ factor: 0.58, wrcAdj: -18, reliability: 0.35, label: "High-A" },
  AA:  { factor: 0.68, wrcAdj: -10, reliability: 0.50, label: "Double-A" },
  AAA: { factor: 0.82, wrcAdj: -4,  reliability: 0.62, label: "Triple-A" },
  MLB: { factor: 1.00, wrcAdj: 0,   reliability: 0.80, label: "MLB" },
};

// ── FUTURE VALUE LOOKUP TABLE ───────────────────────────────────────────────
// FanGraphs 2026 prospect FV grades - Updated Feb 2026
const FV_LOOKUP = {
  // 70 FV — Iridescent (only Konnor Griffin)
  804606: 70, // Konnor Griffin
  // 65 FV — Crimson
  815908: 65, // Jesús Made
  690997: 65, // Nolan McLean
  4917646: 65, // Samuel Basallo
  // 60 FV — Diamond
  805808: 60, // Kevin McGonigle
  808651: 60, // Leo De Vries
  808650: 60, // Max Clark
  808648: 60, // Trey Yesavage
  808663: 60, // Thomas White
  4683325: 60, // Bubba Chandler
  808649: 60, // Colt Emerson
  // 55 FV — Platinum
  808795: 55, // Franklin Arias
  808796: 55, // Eli Willits
  808671: 55, // Bryce Eldridge
  808672: 55, // Josue De Paula
  808665: 55, // Ryan Sloan
  808652: 55, // Carson Benge
  808659: 55, // Alfredo Duno
  808668: 55, // Bryce Rainer
  808669: 55, // Luis Peña
  808657: 55, // Rainiel Rodriguez
  808691: 55, // Chase DeLauter
  4917606: 55, // Andrew Painter
  808694: 55, // Carson Williams
  808797: 55, // Jarlin Susana
  808658: 55, // Sebastian Walcott
  808655: 55, // Walker Jenkins
  808695: 55, // Carter Jensen
  808667: 55, // Caleb Bonemer
  808654: 55, // Sal Stewart
  808680: 55, // Ryan Waldschmidt
  808696: 55, // Noah Schultz
  808673: 55, // Brandon Sproat
  808661: 55, // Connelly Early
  808681: 55, // Dylan Beavers
  808656: 55, // Edward Florentino
  808795: 55, // Aidan Miller
  808666: 55, // Kade Anderson
  808677: 55, // Jonah Tong
  808662: 55, // Robby Snelling
  808664: 55, // Gage Jump
  808667: 55, // Caleb Bonemer
  808670: 55, // Josuar Gonzalez
  808675: 55, // George Lombard Jr.
  808678: 55, // Seth Hernandez
  808660: 55, // Josue Briceño
  808676: 55, // Leo De Vries
};

const FV_BY_NAME = {
  "Konnor Griffin": 70,
  "Jesus Made": 65, "Jesús Made": 65,
  "Nolan McLean": 65,
  "Samuel Basallo": 65,
  "Kevin McGonigle": 60,
  "Leo De Vries": 60,
  "Max Clark": 60,
  "Trey Yesavage": 60,
  "Thomas White": 60,
  "Bubba Chandler": 60,
  "Colt Emerson": 60,
  "Franklin Arias": 55, "Eli Willits": 55,
  "Bryce Eldridge": 55, "Josue De Paula": 55,
  "Ryan Sloan": 55, "Carson Benge": 55,
  "Alfredo Duno": 55, "Bryce Rainer": 55,
  "Luis Peña": 55, "Rainiel Rodriguez": 55,
  "Chase DeLauter": 55, "Andrew Painter": 55,
  "Carson Williams": 55, "Jarlin Susana": 55,
  "Sebastian Walcott": 55, "Walker Jenkins": 55,
  "Carter Jensen": 55, "Caleb Bonemer": 55,
  "Sal Stewart": 55, "Ryan Waldschmidt": 55,
  "Noah Schultz": 55, "Brandon Sproat": 55,
  "Connelly Early": 55, "Dylan Beavers": 55,
  "Edward Florentino": 55, "Aidan Miller": 55,
  "Kade Anderson": 55, "Jonah Tong": 55,
  "Robby Snelling": 55, "Gage Jump": 55,
  "George Lombard Jr.": 55, "Seth Hernandez": 55,
  "Josue Briceño": 55, "Josuar Gonzalez": 55,
  "Payton Tolle": 55, "Luis Mey": 55,
  "JJ Wetherholt": 55,
  "Colson Montgomery": 55, "Roman Anthony": 55,
  "Marcelo Mayer": 55, "Jordan Lawlar": 55,
  "Dylan Crews": 55, "Wyatt Langford": 55,
  "Jackson Holliday": 55, "Junior Caminero": 55,
  "Termarr Johnson": 55, "Coby Mayo": 55,
  "Kristian Campbell": 55,
  "Roki Sasaki": 60, "Paul Skenes": 60,
  "Chase Burns": 55, "Jared Jones": 55,
  "Quinn Mathews": 55, "Jacob Misiorowski": 55,
  "AJ Smith-Shawver": 55, "Tanner Bibee": 55,
  "Chase Petty": 55, "Noble Meyer": 55,
  "Caden Dana": 55, "Luis Gil": 55,
  "Hagen Smith": 50,
  "Jackson Ferris": 50, "Richard Fitts": 50,
  "Gunnar Hoglund": 50, "Logan Henderson": 50,
  "Jurrangelo Cijntje": 50, "Eury Perez": 50,
  "Grayson Rodriguez": 50, "Hunter Brown": 50,
  "Chase Dollander": 50, "Rhett Lowder": 50,
  "Drew Thorpe": 50, "Tobias Myers": 50,
  "Nick Nastrini": 50, "Ben Joyce": 50,
  "Travis Bazzana": 50, "Ethan Salas": 50,
  "Braden Montgomery": 50, "Ethan Holliday": 50,
  "Jett Williams": 50, "Arjun Nimmala": 50,
  "Alan Roden": 50, "Jac Caglianone": 50,
  "Michael Arroyo": 50, "Jacob Reimer": 50,
  "Joshua Baez": 50, "Ralphy Velazquez": 50,
  "Aiva Arquette": 50, "Joe Mack": 50,
  "Mike Sirota": 50, "Dylan Beavers": 50,
  "Robert Hassell III": 50, "Heston Kjerstad": 50,
  "Matt Shaw": 50, "Jace Jung": 50,
  "Brady House": 50, "Nick Kurtz": 50,
  "Jacob Wilson": 50, "Kyle Teel": 50,
  "Drake Baldwin": 50, "James Wood": 50,
  "Pete Crow-Armstrong": 50, "Dalton Rushing": 50,
  "Tyler Soderstrom": 50, "Cam Smith": 50,
  "Zac Veen": 50, "Brooks Lee": 50,
  "Noelvi Marte": 50, "Henry Davis": 50,
  "Logan O'Hoppe": 50, "Dillon Dingler": 50,
  "Owen Caissie": 50, "Jackson Merrill": 50,
  "Jackson Chourio": 50, "Evan Carter": 50,
  "Andy Pages": 50, "Masyn Winn": 45,
  "Ceddanne Rafaela": 45, "Zach Neto": 45,
  "Anthony Volpe": 45, "Ezequiel Tovar": 45,
  "Jordan Westburg": 45, "Colton Cowser": 45,
  "Bryson Stott": 45, "Michael Harris II": 45,
  "Riley Greene": 45, "Colt Keith": 45,
  "Maikel Garcia": 45, "Mark Vientos": 45,
  "Spencer Steer": 45, "Geraldo Perdomo": 45,
  "Triston Casas": 45, "Matt McLain": 45,
  "Nick Gonzales": 45, "Connor Norby": 45,
  "Joey Ortiz": 45, "Victor Scott II": 45,
  "Tyler Fitzgerald": 45,
};

// FV badge styles

function getPlayerFV(playerId, playerName) {
  if (playerId && FV_LOOKUP[playerId]) return FV_LOOKUP[playerId];
  if (playerName && FV_BY_NAME[playerName]) return FV_BY_NAME[playerName];
  return null;
}

const FV_STYLES = {
  70: { label: "70 FV", bg: "linear-gradient(135deg, #ff6b9d, #c084fc, #60a5fa, #4ade80, #facc15, #fb923c)", color: "#fff", border: "none", glow: true },
  65: { label: "65 FV", bg: "linear-gradient(135deg, #dc2626, #991b1b, #7f1d1d)", color: "#fff", border: "none", glow: false },
  60: { label: "60 FV", bg: "linear-gradient(135deg, #93c5fd, #c4b5fd, #e0e7ff)", color: "#1e3a5f", border: "none", glow: false },
  55: { label: "55 FV", bg: "linear-gradient(135deg, #34d399, #10b981, #059669)", color: "#ffffff", border: "none", glow: false },
  50: { label: "50 FV", bg: "linear-gradient(135deg, #fef3c7, #fcd34d, #f59e0b)", color: "#78350f", border: "none", glow: false },
  45: { label: "45 FV", bg: "linear-gradient(135deg, #d4d4d8, #a1a1aa, #d4d4d8)", color: "#3f3f46", border: "none", glow: false },
  40: { label: "40 FV", bg: "linear-gradient(135deg, #d97706, #b45309, #92400e)", color: "#fef3c7", border: "none", glow: false },

};

function getFVStyle(fv) {
  if (fv >= 70) return FV_STYLES[70];
  if (fv >= 65) return FV_STYLES[65];
  if (fv >= 60) return FV_STYLES[60];
  if (fv >= 55) return FV_STYLES[55];
  if (fv >= 50) return FV_STYLES[50];
  if (fv >= 45) return FV_STYLES[45];
  return FV_STYLES[40];
}

// ── STATCAST LOOKUP (batted ball data for top prospects) ────────────────────
// avgEV (mph), maxEV (mph), barrelPct (%)
const STATCAST_DATA = {
  "Konnor Griffin":   { avgEV: 90.2, maxEV: 107.9, barrelPct: 12.5 },
  "Kevin McGonigle":  { avgEV: 88.8, maxEV: 105.1, barrelPct: 10.8 },
  "Carter Jensen":    { avgEV: 89.5, maxEV: 107.3, barrelPct: 14.2 },
  "JJ Wetherholt":    { avgEV: 88.1, maxEV: 105.8, barrelPct: 9.5 },
  "Jesus Made":       { avgEV: 87.5, maxEV: 104.2, barrelPct: 6.8 },
  "Jesús Made":       { avgEV: 87.5, maxEV: 104.2, barrelPct: 6.8 },
  "Max Clark":        { avgEV: 87.0, maxEV: 104.5, barrelPct: 7.2 },
  "Colt Emerson":     { avgEV: 88.4, maxEV: 106.1, barrelPct: 10.1 },
  "Aidan Miller":     { avgEV: 88.9, maxEV: 106.5, barrelPct: 11.0 },
  "Samuel Basallo":   { avgEV: 91.3, maxEV: 110.2, barrelPct: 15.8 },
  "Sal Stewart":      { avgEV: 89.2, maxEV: 106.8, barrelPct: 11.5 },
  "Walker Jenkins":   { avgEV: 87.8, maxEV: 105.0, barrelPct: 8.5 },
  "Sebastian Walcott":{ avgEV: 88.0, maxEV: 106.0, barrelPct: 9.0 },
  "Bryce Eldridge":   { avgEV: 90.5, maxEV: 108.5, barrelPct: 13.2 },
  "Travis Bazzana":   { avgEV: 87.5, maxEV: 104.0, barrelPct: 8.0 },
  "Ethan Salas":      { avgEV: 86.5, maxEV: 103.5, barrelPct: 7.0 },
  "Carson Williams":  { avgEV: 87.2, maxEV: 104.8, barrelPct: 8.2 },
};


function getStatcast(playerName) {
  return STATCAST_DATA[playerName] || null;
}

function getXwoba(playerName) {
  return XWOBA_DATA[playerName] || null;
}


// ── DEFENSIVE LOOKUP (OAA 2023-2025 avg, DRS directional) ──────────────────
// OAA = Outs Above Average (Baseball Savant). Runs = OAA * 1.75
// DRS = Defensive Runs Saved directional: +/0/- (above/avg/below)
const DEFENSIVE_DATA = {
  "Bobby Witt Jr.":      { oaa: 8,  drs: 1 },
  "Gunnar Henderson":    { oaa: 6,  drs: 1 },
  "Trea Turner":         { oaa: 2,  drs: 1 },
  "Francisco Lindor":    { oaa: 10, drs: 1 },
  "Corey Seager":        { oaa: -2, drs: 0 },
  "Xander Bogaerts":     { oaa: -4, drs: -1 },
  "Willy Adames":        { oaa: 3,  drs: 1 },
  "Elly De La Cruz":     { oaa: 2,  drs: 0 },
  "Anthony Volpe":       { oaa: 4,  drs: 1 },
  "Masyn Winn":          { oaa: 7,  drs: 1 },
  "CJ Abrams":           { oaa: 3,  drs: 1 },
  "Mookie Betts":        { oaa: 5,  drs: 1 },
  "Ronald Acuna Jr.":    { oaa: 3,  drs: 1 },
  "Corbin Carroll":      { oaa: 7,  drs: 1 },
  "Julio Rodriguez":     { oaa: 4,  drs: 1 },
  "Aaron Judge":         { oaa: 2,  drs: 1 },
  "Mike Trout":          { oaa: -3, drs: 0 },
  "Fernando Tatis Jr.":  { oaa: 1,  drs: 0 },
  "Jazz Chisholm Jr.":   { oaa: 3,  drs: 1 },
  "Ozzie Albies":        { oaa: 4,  drs: 1 },
  "Jose Altuve":         { oaa: 2,  drs: 1 },
  "Marcus Semien":       { oaa: 1,  drs: 0 },
  "Ketel Marte":         { oaa: 3,  drs: 1 },
  "Ha-Seong Kim":        { oaa: 8,  drs: 1 },
  "Nico Hoerner":        { oaa: 6,  drs: 1 },
  "Adley Rutschman":     { oaa: 5,  drs: 1 },
  "William Contreras":   { oaa: -2, drs: 0 },
  "J.T. Realmuto":       { oaa: 4,  drs: 1 },
  "Freddie Freeman":     { oaa: 2,  drs: 0 },
  "Matt Olson":          { oaa: -1, drs: 0 },
  "Pete Alonso":         { oaa: -3, drs: -1 },
  "Nolan Arenado":       { oaa: 8,  drs: 1 },
  "Austin Riley":        { oaa: 3,  drs: 1 },
  "Rafael Devers":       { oaa: -6, drs: -1 },
  "Manny Machado":       { oaa: 3,  drs: 1 },
  "Jose Ramirez":        { oaa: 4,  drs: 1 },
  "Alex Bregman":        { oaa: 2,  drs: 1 },
  "Kyle Tucker":         { oaa: 2,  drs: 1 },
  "Yordan Alvarez":      { oaa: -4, drs: -1 },
  "Juan Soto":           { oaa: -3, drs: -1 },
  "Bryce Harper":        { oaa: -2, drs: 0 },
  "Giancarlo Stanton":   { oaa: -5, drs: -1 },
  "Christian Yelich":    { oaa: 1,  drs: 0 },
  "Kyle Schwarber":      { oaa: -8, drs: -1 },
  "Jackson Chourio":     { oaa: 2,  drs: 1 },
  "Wyatt Langford":      { oaa: 1,  drs: 0 },
  "Riley Greene":        { oaa: 2,  drs: 0 },
  "Michael Harris II":   { oaa: 6,  drs: 1 },
  "Jarren Duran":        { oaa: 4,  drs: 1 },
  "Steven Kwan":         { oaa: 3,  drs: 1 },
  "Pete Crow-Armstrong": { oaa: 8,  drs: 1 },
  "Jackson Merrill":     { oaa: 3,  drs: 0 },
  "Tarik Skubal":        { oaa: 2,  drs: 1 },
  "Logan Webb":          { oaa: 3,  drs: 1 },
  "Zack Wheeler":        { oaa: 1,  drs: 1 },
};

// ── SPRINT SPEED LOOKUP (ft/sec, Baseball Savant 2024) ──────────────────────
// Elite: >29, Above avg: 27-29, Avg: 26-27, Below: <26
const SPRINT_SPEED = {
  "Elly De La Cruz":     30.2,
  "Bobby Witt Jr.":      29.8,
  "Corbin Carroll":      30.1,
  "Julio Rodriguez":     28.9,
  "Ronald Acuna Jr.":    29.6,
  "Trea Turner":         30.4,
  "Jazz Chisholm Jr.":   29.1,
  "Jackson Chourio":     29.3,
  "Wyatt Langford":      28.5,
  "Riley Greene":        28.2,
  "Jarren Duran":        29.4,
  "Steven Kwan":         28.1,
  "CJ Abrams":           29.7,
  "Masyn Winn":          29.2,
  "Anthony Volpe":       27.8,
  "Gunnar Henderson":    27.5,
  "Francisco Lindor":    27.9,
  "Mookie Betts":        27.6,
  "Fernando Tatis Jr.":  28.3,
  "Ketel Marte":         27.4,
  "Ha-Seong Kim":        27.8,
  "Willy Adames":        27.1,
  "Michael Harris II":   29.8,
  "Pete Crow-Armstrong": 29.5,
  "Jackson Merrill":     27.9,
  "Aaron Judge":         27.2,
  "Juan Soto":           26.8,
  "Bryce Harper":        26.5,
  "Freddie Freeman":     26.9,
  "Mike Trout":          26.4,
  "Kyle Tucker":         27.0,
  "Yordan Alvarez":      25.8,
  "Rafael Devers":       25.6,
  "Pete Alonso":         24.9,
  "Kyle Schwarber":      24.7,
  "Giancarlo Stanton":   25.2,
  "Nolan Arenado":       26.1,
  "Jose Ramirez":        27.3,
  "Austin Riley":        26.8,
  "Jose Altuve":         27.5,
};

function getDefense(playerName) { return DEFENSIVE_DATA[playerName] || null; }
function getSprintSpeed(playerName) { return SPRINT_SPEED[playerName] || null; }


// ── API FUNCTIONS ───────────────────────────────────────────────────────────
async function searchPlayers(query) {
  try {
    const res = await fetch(`${API}/people/search?names=${encodeURIComponent(query)}&sportIds=1,11,12,13,14,16&hydrate=currentTeam,team`);
    const data = await res.json();
    return (data.people || []).slice(0, 25);
  } catch { return []; }
}

async function getPlayerStats(playerId) {
  try {
    const res = await fetch(`${API}/people/${playerId}?hydrate=currentTeam,team`);
    const data = await res.json();
    return data.people?.[0] || null;
  } catch { return null; }
}

async function getPlayerCareer(playerId, group = "hitting") {
  const sportIds = [1, 11, 12, 13, 14, 16];
  try {
    const promises = sportIds.map(sid =>
      fetch(`${API}/people/${playerId}/stats?stats=yearByYear&group=${group}&gameType=R&sportId=${sid}`)
        .then(r => r.json())
        .then(d => {
          const splits = d.stats?.[0]?.splits || [];
          return splits.map(s => ({ ...s, _sportId: sid }));
        })
        .catch(() => [])
    );
    const allResults = await Promise.all(promises);
    return allResults.flat();
  } catch { return []; }
}

async function getTeams(sportId = 1) {
  try {
    const res = await fetch(`${API}/teams?sportId=${sportId}&season=2025`);
    const data = await res.json();
    return (data.teams || []).sort((a, b) => a.name.localeCompare(b.name));
  } catch { return []; }
}

async function getTeamRoster(teamId) {
  try {
    const res = await fetch(`${API}/teams/${teamId}/roster/fullSeason?season=2025`);
    const data = await res.json();
    return data.roster || [];
  } catch { return []; }
}

async function getMiLBAffiliate(mlbTeamId) {
  try {
    const res = await fetch(`${API}/teams/affiliates?teamIds=${mlbTeamId}&season=2025&sportIds=11,12,13,14,16`);
    const data = await res.json();
    return (data.teams || []).sort((a, b) => (a.sport?.id || 99) - (b.sport?.id || 99));
  } catch { return []; }
}

// ── PROJECTION ENGINE ────────────────────────────────────────────────────────
const AGING_PARAMS = {
  C:  { peak: 28, dr: 0.032, pa: -1.0, dd: 0.05 },
  "1B":{ peak: 28, dr: 0.032, pa: -12.5, dd: 0.02 },
  "2B":{ peak: 27, dr: 0.038, pa: 2.5,   dd: 0.05 },
  "3B":{ peak: 27, dr: 0.035, pa: 2.5,   dd: 0.04 },
  SS: { peak: 26, dr: 0.040, pa: 7.5,   dd: 0.055 },
  LF: { peak: 28, dr: 0.033, pa: -7.5,  dd: 0.035 },
  CF: { peak: 27, dr: 0.037, pa: 2.5,   dd: 0.05 },
  RF: { peak: 28, dr: 0.034, pa: -5.0,  dd: 0.04 },
  DH: { peak: 29, dr: 0.030, pa: -17.5, dd: 0.0 },
};

// Pitcher aging parameters
const PITCHER_AGING = { SP: { peak: 27, dr: 0.025 }, RP: { peak: 28, dr: 0.030 } };

// Pitcher MiLB translation factors (ERA/FIP scale — lower = better, so factor < 1 means inflate)
const PITCHER_TRANSLATION = {
  MLB: { factor: 1.0, label: "Major League" },
  AAA: { factor: 0.85, label: "Triple-A" },
  AA:  { factor: 0.78, label: "Double-A" },
  "A+":{ factor: 0.70, label: "High-A" },
  A:   { factor: 0.62, label: "Single-A" },
  "A-":{ factor: 0.55, label: "Short Season" },
  ROK: { factor: 0.48, label: "Rookie" },
};

function getAP(code) {
  const m = {"2":"C","3":"1B","4":"2B","5":"3B","6":"SS","7":"LF","8":"CF","9":"RF","10":"DH"};
  return AGING_PARAMS[m[code]||code] || { peak:28, dr:0.035, pa:0, dd:0.03 };
}
function posLabel(c) {
  if (c === "1") return "P";
  const map = {C:"C","2":"C","3":"1B","4":"2B","5":"3B","6":"SS","7":"LF","8":"CF","9":"RF","10":"DH","D":"DH","Y":"TWP","O":"OF"};
  return map[c] || c || "—";
}

function detectLevel(split) {
  if (split._sportId) return LEVEL_NAMES[split._sportId] || "MLB";
  const sid = split.sport?.id || split.team?.sport?.id;
  return LEVEL_NAMES[sid] || "MLB";
}

// Historical MLB outcome benchmarks by FV tier (peak season OPS / WAR / wRC+)
// Based on FanGraphs research on prospect outcome distributions
const FV_BENCHMARKS = {
  70: { ops: .940, war: 7.0, wrc: 150, floor_ops: .850, ceil_ops: 1.050 },
  65: { ops: .870, war: 5.0, wrc: 135, floor_ops: .780, ceil_ops: .960 },
  60: { ops: .820, war: 3.5, wrc: 125, floor_ops: .720, ceil_ops: .900 },
  55: { ops: .780, war: 2.5, wrc: 115, floor_ops: .690, ceil_ops: .860 },
  50: { ops: .740, war: 1.8, wrc: 105, floor_ops: .660, ceil_ops: .820 },
  45: { ops: .710, war: 1.0, wrc: 98,  floor_ops: .640, ceil_ops: .780 },
  40: { ops: .680, war: 0.5, wrc: 90,  floor_ops: .620, ceil_ops: .750 },
};

const AVG_AGE_AT_LEVEL = { ROK: 18.5, A: 20.5, "A+": 22, AA: 23, AAA: 24.5, MLB: 27 };

function projectFromSeasons(splits, age, posCode, playerName, playerId) {
  const valid = splits
    .filter(s => s.stat?.plateAppearances > 30)
    .sort((a, b) => parseInt(b.season) - parseInt(a.season))
    .slice(0, 3);
  if (!valid.length) return null;

  const fv = getPlayerFV(playerId, playerName);
  const sc = getStatcast(playerName);
  const currentYear = 2025;

  // PA-weighted Marcel with recency multiplier
  // Season weights: most recent=5, prior=4, oldest=3 — but scaled by actual PA
  const RECENCY = [1.0, 0.85, 0.70];
  let tw = 0, wOPS = 0, wPA = 0, wHR = 0, wAVG = 0, wOBP = 0, wSLG = 0;
  let highestLevel = "ROK";
  let youngestAgeAtHighest = 99;
  let totalRawPA = 0;

  valid.forEach((s, i) => {
    const st = s.stat;
    const pa = st.plateAppearances || 0;
    const lvl = detectLevel(s);
    const seasonsAgo = currentYear - parseInt(s.season);
    // Weight = PA * recency * base season weight (5/4/3)
    const baseW = [5, 4, 3][i] || 2;
    const w = pa * RECENCY[i] * baseW / 600; // normalize by 600 PA season
    const lvlIdx = LEVEL_ORDER.indexOf(lvl);
    if (lvlIdx > LEVEL_ORDER.indexOf(highestLevel)) {
      highestLevel = lvl;
      youngestAgeAtHighest = age - seasonsAgo;
    }
    const trans = LEVEL_TRANSLATION[lvl] || LEVEL_TRANSLATION.MLB;
    tw += w;
    wOPS += parseFloat(st.ops || 0) * trans.factor * w;
    wAVG += parseFloat(st.avg || 0) * trans.factor * w;
    wOBP += parseFloat(st.obp || 0) * trans.factor * w;
    wSLG += parseFloat(st.slg || 0) * trans.factor * w;
    wHR += (st.homeRuns || 0) * w;
    wPA += pa * w;
    totalRawPA += pa;
  });

  const rawOPS = wOPS / tw;
  const rawPA = totalRawPA / valid.length;
  const trans = LEVEL_TRANSLATION[highestLevel] || LEVEL_TRANSLATION.MLB;

  // Age-for-level: exponential for extreme youth advantage
  const avgAge = AVG_AGE_AT_LEVEL[highestLevel] || 23;
  const ageAdvantage = avgAge - youngestAgeAtHighest;
  // Exponential: 2yr young = ~16% boost, 4yr young = ~35% boost
  const ageBoost = highestLevel === "MLB" ? 1.0 :
    1 + Math.max(-0.08, Math.min(0.35, ageAdvantage > 0
      ? Math.pow(ageAdvantage, 1.3) * 0.065
      : ageAdvantage * 0.06));

  // Elite performance scaling: less regression for outliers
  const rawPreTransOPS = rawOPS / (trans.factor || 1);
  const xw = getXwoba(playerName);

  const eliteThreshold = highestLevel === "MLB" ? 0.800 : 0.860;
  const performanceBoost = rawPreTransOPS > eliteThreshold
    ? 1 + Math.min(0.18, (rawPreTransOPS - eliteThreshold) * 0.9)
    : 1.0;

  // Statcast adjustment
  let statcastBoost = 1.0;
  if (sc) {
    const evScore = Math.max(0, (sc.avgEV - 86) / 8);
    const maxScore = Math.max(0, (sc.maxEV - 104) / 8);
    const barrelScore = Math.max(0, (sc.barrelPct - 6) / 10);
    statcastBoost = 1 + (evScore * 0.08 + maxScore * 0.05 + barrelScore * 0.12);
  }


  const adjustedOPS = rawOPS * ageBoost * performanceBoost * statcastBoost;
  
  // xwOBA adjustment: boost for unlucky BABIP
  let xwobaBoost = 1.0;
  if (xw && xw.xwoba > 0) {
    const impliedWoba = rawOPS * 0.43;
    const xwobaDiff = xw.xwoba - impliedWoba;
    if (xwobaDiff > 0.01) {
      xwobaBoost = 1 + Math.min(0.15, xwobaDiff * 1.5);
    }
  }
  const finalAdjustedOPS = adjustedOPS * xwobaBoost;

  // Reliability: scales with PA and level, cap higher for MLB
  const paRel = Math.min(highestLevel === "MLB" ? 0.92 : 0.82,
    (totalRawPA / (valid.length * 500)) * trans.reliability);
  const lgOPS = 0.720;

  let finalOPS, finalWRC;
  if (fv && highestLevel !== "MLB") {
    const bench = FV_BENCHMARKS[Math.min(70, Math.max(40, fv))] || FV_BENCHMARKS[50];
    // PA-scaled blend: >400 PA = trust stats heavily, <100 PA = trust FV heavily
    const statWeight = Math.min(0.75, Math.max(0.2, paRel * 0.9));
    const fvWeight = 1 - statWeight;
    const statsOPS = finalAdjustedOPS * paRel + lgOPS * (1 - paRel);
    finalOPS = statsOPS * statWeight + bench.ops * fvWeight;
    finalWRC = Math.round((finalOPS / lgOPS) * 100);
  } else {
    finalOPS = finalAdjustedOPS * paRel + lgOPS * (1 - paRel);
    finalWRC = Math.round((finalOPS / lgOPS) * 100) + Math.round(trans.wrcAdj * (1 - paRel));
  }

  finalOPS = Math.max(0.560, Math.min(1.100, finalOPS));
  finalWRC = Math.max(65, Math.min(185, finalWRC));

  const ap = getAP(posCode);
  const estPA = highestLevel === "MLB"
    ? Math.min(700, rawPA * 0.97)
    : Math.min(650, rawPA * 0.93);
  const def = getDefense(playerName);
  const spd = getSprintSpeed(playerName);

  // Defensive runs: OAA * 1.75 (primary) blended with DRS direction (secondary)
  // Decays with age past defensive peak (pos-specific)
  const defPeak = posCode === "6" || posCode === "8" ? 26 : 28;
  const defAge = Math.max(0, 1 - Math.max(0, age - defPeak) * 0.06);
  let defRuns = 0;
  if (def) {
    const oaaRuns = def.oaa * 1.75;
    const drsAdj = def.drs * 1.5;
    defRuns = (oaaRuns * 0.70 + drsAdj * 0.30) * defAge * (estPA / 600);
  }

  // ── BASERUNNING RUNS ──────────────────────────────────────────────────────
  // MLB players: use sprint speed lookup
  // MiLB players: derive speed tier from career SB/CS/G
  let bsrRuns = 0;
  if (spd !== null) {
    // MLB sprint speed path
    const speedTier = spd >= 29.5 ? 6.0 : spd >= 28.5 ? 4.0 : spd >= 28.0 ? 3.0 : spd >= 27.0 ? 1.5 : spd >= 26.0 ? 0 : -2.0;
    bsrRuns = speedTier * (estPA / 600);
  } else if (highestLevel !== "MLB") {
    // MiLB derived baserunning
    // Pull career SB/CS/G from weighted stats
    const totalSB = valid.reduce((sum, s) => sum + (s.stat?.stolenBases || 0), 0);
    const totalCS = valid.reduce((sum, s) => sum + (s.stat?.caughtStealing || 0), 0);
    const totalG = valid.reduce((sum, s) => sum + (s.stat?.gamesPlayed || 0), 0);
    if (totalG > 0) {
      const sbPerGame = totalSB / totalG;
      const attempts = totalSB + totalCS;
      const csPct = attempts > 0 ? totalCS / attempts : 0.25;
      // SB rate tiers: >0.25/g = elite, 0.15-0.25 = good, 0.08-0.15 = avg, <0.08 = slow
      const sbTier = sbPerGame >= 0.25 ? 4 : sbPerGame >= 0.15 ? 2.5 : sbPerGame >= 0.08 ? 1 : 0;
      // Efficiency penalty: CS% > 30% reduces value, < 20% adds value
      // Break-even CS% is ~25% (SB worth 0.20 runs, CS costs 0.40 runs)
      const effMult = csPct <= 0.20 ? 1.25 : csPct <= 0.25 ? 1.0 : csPct <= 0.33 ? 0.75 : 0.4;
      // Volume confidence: more attempts = more reliable signal
      const confidence = Math.min(1.0, attempts / 30);
      // Net SB runs value
      const sbRunsRaw = (totalSB * 0.20 - totalCS * 0.40) / Math.max(1, totalG) * 162;
      // Blend tier-based and raw SB value
      bsrRuns = (sbTier * effMult * confidence * 0.6 + sbRunsRaw * 0.4) * (estPA / 600);
      bsrRuns = Math.max(-3, Math.min(6, bsrRuns));
    }
  }


  const batRuns = ((finalWRC - 100) / 100) * estPA * 0.115;
  const posAdj = ap.pa * (estPA / 600);
  const repl = 20 * (estPA / 600);
  const baseWAR = (batRuns + defRuns + bsrRuns + posAdj + repl) / 9.5;








  let clampedWAR = baseWAR;
  if (fv) {
    const bench = FV_BENCHMARKS[Math.min(70, Math.max(40, fv))] || FV_BENCHMARKS[50];
    clampedWAR = Math.max(bench.war * 0.35, Math.min(bench.war * 1.7, baseWAR));
  }

  const finalOBP = (wOBP/tw) * ageBoost * performanceBoost;
  const finalSLG = (wSLG/tw) * ageBoost * performanceBoost;
  const peakAge = (getAP(posCode)).peak;

  return {
    ops: finalOPS,
    obp: Math.max(0.275, Math.min(0.430, finalOBP * paRel + 0.315 * (1 - paRel))),
    slg: Math.max(0.310, Math.min(0.620, finalSLG * paRel + 0.405 * (1 - paRel))),
    avg: Math.max(0.210, Math.min(0.330, (wAVG/tw) * ageBoost * paRel + 0.248 * (1 - paRel))),
    wRCPlus: finalWRC,
    baseWAR: Math.round(clampedWAR * 10) / 10,
    estPA: Math.round(estPA),
    hr: Math.round((wHR/tw) * (estPA / Math.max(1, rawPA)) * ageBoost * performanceBoost),
    paReliability: Math.round(paRel * 100),
    highestLevel,
    peakAge,
    ageForLevel: Math.round(ageAdvantage * 10) / 10,
    translationNote: highestLevel !== "MLB"
      ? `Stats translated from ${trans.label} (${Math.round(trans.factor*100)}% factor)${ageAdvantage > 0 ? ` · ${ageAdvantage.toFixed(1)}yr young for level` : ""}` 
      : null,
  };
}

function projectPitcherFromSeasons(splits, age, playerName, playerId) {
  const valid = splits
    .filter(s => s.stat?.inningsPitched && parseFloat(s.stat.inningsPitched) > 10)
    .sort((a, b) => parseInt(b.season) - parseInt(a.season))
    .slice(0, 3);
  if (!valid.length) return null;

  const fv = getPlayerFV(playerId, playerName);
  const RECENCY = [1.0, 0.85, 0.70];
  let tw = 0, wERA = 0, wIP = 0, wK9 = 0, wBB9 = 0, wWHIP = 0, wHR9 = 0, wW = 0, wL = 0, wSV = 0;
  let highestLevel = "ROK";
  let youngestAgeAtHighest = 99;
  let totalRawIP = 0;

  valid.forEach((s, i) => {
    const st = s.stat;
    const ip = parseFloat(st.inningsPitched) || 0;
    const lvl = detectLevel(s);
    const seasonsAgo = 2025 - parseInt(s.season);
    const baseW = [5, 4, 3][i] || 2;
    const w = ip * RECENCY[i] * baseW / 180;
    const lvlIdx = LEVEL_ORDER.indexOf(lvl);
    if (lvlIdx > LEVEL_ORDER.indexOf(highestLevel)) {
      highestLevel = lvl;
      youngestAgeAtHighest = age - seasonsAgo;
    }
    const trans = PITCHER_TRANSLATION[lvl] || PITCHER_TRANSLATION.MLB;
    tw += w;
    wERA += parseFloat(st.era || 4.50) / trans.factor * w;
    wK9 += parseFloat(st.strikeoutsPer9Inn || 7.0) * w;
    wBB9 += parseFloat(st.walksPer9Inn || 3.5) * w;
    wWHIP += parseFloat(st.whip || 1.35) / trans.factor * w;
    wHR9 += parseFloat(st.homeRunsPer9 || 1.2) / trans.factor * w;
    wIP += ip * w;
    wW += parseInt(st.wins || 0) * w;
    wL += parseInt(st.losses || 0) * w;
    wSV += parseInt(st.saves || 0) * w;
    totalRawIP += ip;
  });

  const avgAge = AVG_AGE_AT_LEVEL[highestLevel] || 23;
  const ageAdv = avgAge - youngestAgeAtHighest;
  // Fixed: young pitchers should get ERA boost (lower ERA), not penalty
  // Exponential scaling same as hitters
  const ageERAMult = highestLevel === "MLB" ? 1.0 :
    1 - Math.max(-0.06, Math.min(0.18, ageAdv > 0
      ? Math.pow(ageAdv, 1.2) * 0.05
      : ageAdv * 0.04));

  const rawIP = totalRawIP / valid.length;
  const paRel = Math.min(highestLevel === "MLB" ? 0.90 : 0.80, (totalRawIP / (valid.length * 160)) * (PITCHER_TRANSLATION[highestLevel]?.reliability || 0.9));

  // Regress toward league average with recency weighting
  const regERA = (wERA / tw) * paRel + 4.20 * (1 - paRel);
  const regK9 = (wK9 / tw) * paRel + 8.5 * (1 - paRel);
  const regBB9 = (wBB9 / tw) * paRel + 3.2 * (1 - paRel);
  const regWHIP = (wWHIP / tw) * paRel + 1.28 * (1 - paRel);
  const regHR9 = (wHR9 / tw) * paRel + 1.20 * (1 - paRel);

  // Apply age factor correctly: young = lower ERA (better)
  const finalERA = Math.max(1.50, Math.min(6.50, regERA * ageERAMult));
  const finalK9 = Math.max(4.0, Math.min(15.0, regK9 / ageERAMult));
  const finalBB9 = Math.max(1.0, Math.min(6.0, regBB9 * ageERAMult));
  const finalWHIP = Math.max(0.75, Math.min(1.80, regWHIP * ageERAMult));

  const isLikelyStarter = (rawIP / valid.length) > 50 || valid.some(s => (s.stat?.gamesStarted || 0) > 5);
  let estIP;
  if (highestLevel === "MLB") {
    estIP = isLikelyStarter ? Math.max(140, Math.min(210, rawIP * 0.97)) : Math.min(70, rawIP * 0.96);
  } else {
    estIP = isLikelyStarter ? Math.max(120, Math.min(195, rawIP * 1.05)) : Math.min(65, rawIP * 0.92);
  }

  // FIP: ((13*HR)+(3*BB)-(2*K))/IP + 3.10
  const fipConst = 3.10;
  const estK = finalK9 * estIP / 9;
  const estBB = finalBB9 * estIP / 9;
  const estHR = regHR9 * estIP / 9;
  const fip = ((13 * estHR) + (3 * estBB) - (2 * estK)) / estIP + fipConst;
  const finalFIP = Math.max(1.80, Math.min(6.50, fip));

  // Pitcher WAR: FIP-based, scaled by IP
  const lgERA = 4.20;
  const runsPerWin = 9.5;
  const pitchWAR = ((lgERA - finalFIP) / runsPerWin) * (estIP / 9) + (estIP / 200) * 2.0;
  const isReliever = !isLikelyStarter;

  let clampedWAR = Math.max(-1.5, pitchWAR);
  if (fv) {
    const bench = FV_BENCHMARKS[Math.min(70, Math.max(40, fv))] || FV_BENCHMARKS[50];
    clampedWAR = Math.max(bench.war * 0.3, Math.min(bench.war * 1.7, clampedWAR));
  }

  const peakAge = isReliever ? PITCHER_AGING.RP.peak : PITCHER_AGING.SP.peak;

  return {
    era: Math.round(finalERA * 100) / 100,
    fip: Math.round(finalFIP * 100) / 100,
    whip: Math.round(finalWHIP * 100) / 100,
    k9: Math.round(finalK9 * 10) / 10,
    bb9: Math.round(finalBB9 * 10) / 10,
    kPct: Math.round((estK / (estIP * 4.3)) * 1000) / 10,
    bbPct: Math.round((estBB / (estIP * 4.3)) * 1000) / 10,
    ip: Math.round(estIP),
    w: Math.round(wW / tw * (estIP / Math.max(1, rawIP))),
    l: Math.round(wL / tw * (estIP / Math.max(1, rawIP))),
    sv: Math.round(wSV / tw),
    baseWAR: Math.round(clampedWAR * 10) / 10,
    estIP: Math.round(estIP),
    isReliever,
    isPitcher: true,
    peakAge,
    paReliability: Math.round(paRel * 100),
    highestLevel,
    translationNote: highestLevel !== "MLB" ? `${highestLevel} translation applied` : null,
  };
}

function projectPitcherForward(base, age, years = 10) {
  if (!base) return [];
  const ap = base.isReliever ? PITCHER_AGING.RP : PITCHER_AGING.SP;
  const out = [];
  for (let y = 0; y < years; y++) {
    const a = age + y;
    const d = a - ap.peak;
    let f;
    if (d <= 0) {
      const yearsToGo = Math.abs(d);
      f = 1 + Math.min(0.12, (3 - yearsToGo) * 0.03);
      f = Math.max(0.88, Math.min(1.20, f));
    } else {
      f = Math.pow(1 - ap.dr, d);
    }
    out.push({ age: a, war: Math.max(-0.5, base.baseWAR * f) });
  }
  return out;
}

function projectForward(base, age, posCode, years = 10) {
  const ap = getAP(posCode);
  return Array.from({ length: years }, (_, yr) => {
    const a = age + yr;
    if (a > 42) return null;
    const d = a - ap.peak;
    let f;
    if (d <= 0) {
      const yearsToGo = Math.abs(d);
      f = 1 + Math.min(0.12, (3 - yearsToGo) * 0.03);
      f = Math.max(0.88, Math.min(1.25, f));
    } else {
      f = Math.max(0.25, 1 - ap.dr * d);
    }
    const war = Math.max(-1, base.baseWAR * f);
    const wrc = Math.max(60, Math.round(100 + (base.wRCPlus - 100) * f));
    const ops = Math.max(0.500, base.ops * (0.5 + 0.5 * f));
    return {
      age: a, year: 2026 + yr,
      war: Math.round(war*10)/10,
      wrcPlus: wrc,
      ops: Math.round(ops*1000)/1000,
    };
  }).filter(Boolean);
}

// Statcast-enhanced OPS projection for trajectory chart
function projectOPSTrajectory(seasons, base, age, posCode, playerName) {
  if (!base || !seasons.length) return [];
  const sc = getStatcast(playerName);
  const ap = getAP(posCode);

  // Project 3 future seasons only
  const projYears = [2026, 2027, 2028];
  const proj = projYears.map((yr, i) => {
    const a = age + i;
    const d = a - ap.peak;

    let ageFactor;
    if (d <= 0) {
      const yearsToGo = Math.abs(d);
      ageFactor = 1 + Math.min(0.15, yearsToGo * 0.025);
      ageFactor *= (1 - yearsToGo * 0.015);
      ageFactor = Math.max(0.85, Math.min(1.15, ageFactor));
    } else {
      ageFactor = Math.max(0.25, 1 - ap.dr * d);
    }

    // Statcast boost
    let scBoost = 1.0;
    if (sc) {
      const evFactor = Math.max(0, (sc.avgEV - 86) / 8);
      const maxFactor = Math.max(0, (sc.maxEV - 104) / 8);
      const barrelFactor = Math.max(0, (sc.barrelPct - 6) / 10);
      scBoost = 1 + (evFactor * 0.04 + maxFactor * 0.03 + barrelFactor * 0.05);
    }

    const projOPS = Math.max(0.500, base.ops * (0.5 + 0.5 * ageFactor) * scBoost);
    return {
      season: yr.toString(), ops: Math.round(projOPS * 1000) / 1000,
      level: "PROJ", type: "projected",
    };
  });

  return proj;
}

// ── STYLES ───────────────────────────────────────────────────────────────────
const C = {
  bg:"#f5f0e6", panel:"#ffffff", border:"#d4c9b5", hover:"#efe9dd",
  accent:"#c8102e", blue:"#1a3668", green:"#2d6a4f", red:"#c8102e",
  yellow:"#d4a017", purple:"#5b2c8e", cyan:"#0077b6", pink:"#c44569",
  text:"#1b1b1b", dim:"#4a4540", muted:"#8c8272", grid:"#ddd5c5",
  navy:"#1a3668", leather:"#8b5e3c",
};
const F = "'IBM Plex Mono', monospace";
const LEVEL_COLORS = { ROK:"#9ca3af", A:"#0077b6", "A+":"#1a3668", AA:"#5b2c8e", AAA:"#d4a017", MLB:"#2d6a4f", PROJ:"#c8102e" };

// ── COMPONENTS ───────────────────────────────────────────────────────────────
const Panel = ({children,title,sub,style={}}) => (
  <div style={{background:C.panel,border:`1px solid ${C.border}`,borderRadius:10,padding:"16px 20px",...style}}>
    {title&&<div style={{marginBottom:sub?4:12}}>
      <h3 style={{margin:0,fontSize:13,fontWeight:700,color:C.text,letterSpacing:".06em",fontFamily:F}}>{title}</h3>
      {sub&&<p style={{margin:"3px 0 10px",fontSize:11,color:C.muted,lineHeight:1.4,fontFamily:F}}>{sub}</p>}
    </div>}
    {children}
  </div>
);
const Stat = ({label,value,color=C.accent,sub}) => (
  <div style={{padding:"8px 12px",background:`${color}08`,borderRadius:8,border:`1px solid ${color}20`,minWidth:70,textAlign:"center"}}>
    <div style={{fontSize:20,fontWeight:800,color,fontFamily:F}}>{value}</div>
    <div style={{fontSize:8,color:C.muted,marginTop:1,textTransform:"uppercase",letterSpacing:".08em",fontFamily:F}}>{label}</div>
    {sub&&<div style={{fontSize:8,color:C.dim,fontFamily:F}}>{sub}</div>}
  </div>
);
const Pill = ({label,active,onClick,color=C.accent}) => (
  <button onClick={onClick} style={{padding:"5px 14px",border:"none",borderRadius:6,cursor:"pointer",fontSize:11,fontWeight:active?700:500,fontFamily:F,background:active?color:"#efe9dd",color:active?"#fff":C.muted}}>{label}</button>
);
const LevelBadge = ({level}) => (
  <span style={{fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:4,fontFamily:F,background:`${LEVEL_COLORS[level]||C.muted}20`,color:LEVEL_COLORS[level]||C.muted}}>{level}</span>
);

const FVBadge = ({fv}) => {
  if (!fv) return null;
  const s = getFVStyle(fv);
  return (
    <span style={{
      fontSize:10, fontWeight:800, padding:"3px 10px", borderRadius:5, fontFamily:F,
      background: s.bg, color: s.color, display:"inline-block", letterSpacing:".04em",
      boxShadow: s.glow ? "0 0 12px rgba(192,132,252,.4), 0 0 24px rgba(96,165,250,.2)" : "none",
      animation: s.glow ? "fvGlow 2s ease-in-out infinite alternate" : "none",
    }}>{s.label}</span>
  );
};

const Spinner = ({msg="Loading..."}) => (
  <div style={{display:"flex",alignItems:"center",gap:8,padding:20,color:C.dim,fontFamily:F,fontSize:12}}>
    <div style={{width:16,height:16,border:`2px solid ${C.border}`,borderTopColor:C.accent,borderRadius:"50%",animation:"spin .8s linear infinite"}}/>
    {msg}
    <style>{`@keyframes spin{to{transform:rotate(360deg)}} @keyframes fvGlow{from{box-shadow:0 0 8px rgba(192,132,252,.3),0 0 16px rgba(96,165,250,.15)}to{box-shadow:0 0 16px rgba(251,146,60,.4),0 0 28px rgba(192,132,252,.25)}}
@media(max-width:768px){
  .via-header{padding:12px 16px 0!important;text-align:center!important}
  .via-header-inner{flex-direction:column!important;align-items:center!important;gap:8px!important}
  .via-search{display:none!important}
  .via-content{padding:8px 12px 20px!important}
  .via-tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap!important;gap:0!important;justify-content:flex-start!important;width:100%!important;scrollbar-width:none!important}
  .via-tabs::-webkit-scrollbar{display:none}
  .via-tabs button{white-space:nowrap;padding:8px 12px!important;font-size:11px!important;flex-shrink:0}
  .via-search{width:100%!important;margin:8px auto 0!important;box-sizing:border-box!important;max-width:400px!important;display:block!important}
  .via-title{font-size:28px!important;text-align:center!important}
  .via-subtitle{font-size:8px!important;letter-spacing:.14em!important;text-align:center!important}
  .via-tagline{font-size:7px!important;text-align:center!important}
  .via-stat-row{gap:4px!important;flex-wrap:wrap!important;justify-content:center!important}
  .via-stat-box{min-width:58px!important;padding:6px 8px!important}
  .via-stat-box .via-stat-val{font-size:14px!important}
  .via-stat-box .via-stat-label{font-size:6px!important}
  .via-panel{padding:10px 12px!important;margin-bottom:8px!important}
  .via-footer{padding:8px 12px!important;flex-direction:column!important;gap:4px!important;text-align:center!important}
  .via-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -12px;padding:0 12px}
  .via-table-wrap table{min-width:500px}
  .via-table-wrap th,.via-table-wrap td{padding:4px 6px!important;font-size:10px!important}
  .via-player-name{font-size:20px!important}
  .via-player-info{font-size:10px!important}
  .via-pos-filters{gap:2px!important}
  .via-pos-filters button{padding:4px 8px!important;font-size:9px!important}
  .via-mode-toggle{gap:2px!important}
  .via-mode-toggle button{padding:5px 12px!important;font-size:10px!important}
  .via-leaderboard-filters{flex-direction:column!important;gap:8px!important;align-items:stretch!important}
  .via-leaderboard-filters input{width:100%!important;box-sizing:border-box!important}
}
@media(max-width:480px){
  .via-title{font-size:24px!important}
  .via-tabs button{padding:7px 10px!important;font-size:10px!important}
  .via-stat-box{min-width:50px!important;padding:5px 6px!important}
  .via-stat-box .via-stat-val{font-size:12px!important}
  .via-table-wrap th,.via-table-wrap td{padding:3px 4px!important;font-size:9px!important}
  .via-player-name{font-size:18px!important}
}`}</style>
  </div>
);
const Tip = ({active,payload,label}) => {
  if(!active||!payload?.length) return null;
  return <div style={{background:"#ffffff",border:`1px solid ${C.border}`,borderRadius:8,padding:"8px 12px",boxShadow:"0 8px 24px rgba(0,0,0,.12)"}}>
    <div style={{fontSize:10,color:C.dim,marginBottom:4,fontFamily:F}}>{label}</div>
    {payload.filter(p=>p.value!=null).map((p,i)=><div key={i} style={{fontSize:11,color:p.color||C.text,fontFamily:F,margin:"1px 0"}}>{p.name}: <strong>{typeof p.value==="number"&&p.value<5?p.value.toFixed(3):p.value}</strong></div>)}
  </div>;
};

// ── PLAYER SEARCH ────────────────────────────────────────────────────────────
function PlayerSearch({onSelect}) {
  const [q,setQ]=useState(""); const [results,setResults]=useState([]); const [show,setShow]=useState(false);
  const ref=useRef(); const search=useMemo(()=>_.debounce(async v=>{if(v.length<2){setResults([]);return;}const r=await searchPlayers(v);setResults(r);setShow(true);},300),[]);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setShow(false);};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[]);
  return (
    <div ref={ref} style={{position:"relative",width:260}}>
      <input value={q} onChange={e=>{setQ(e.target.value);search(e.target.value);}} placeholder="Search player..."
        style={{width:"100%",padding:"8px 12px",borderRadius:8,border:`1px solid ${C.border}`,background:C.panel,color:C.text,fontSize:12,fontFamily:F,outline:"none"}}
        onFocus={()=>results.length&&setShow(true)}/>
      {show&&results.length>0&&<div style={{position:"absolute",top:"100%",left:0,right:0,background:C.panel,border:`1px solid ${C.border}`,borderRadius:8,marginTop:4,maxHeight:320,overflowY:"auto",zIndex:999,boxShadow:"0 12px 36px rgba(0,0,0,.12)"}}>
        {results.map(p=>{
          const fv = getPlayerFV(p.id, p.fullName);
          return <div key={p.id} onClick={()=>{onSelect(p);setShow(false);setQ(p.fullName);}}
            style={{padding:"8px 12px",cursor:"pointer",borderBottom:`1px solid ${C.border}30`,display:"flex",alignItems:"center",justifyContent:"space-between"}}
            onMouseEnter={e=>e.currentTarget.style.background=C.hover} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
            <div>
              <div style={{fontSize:12,fontWeight:600,color:C.text,fontFamily:F}}>{p.fullName}</div>
              <div style={{fontSize:10,color:C.muted,fontFamily:F}}>
                {posLabel(p.primaryPosition?.code)} &middot; {p.currentTeam?.name||"Free Agent"}
                {p.currentTeam?.sport?.id&&p.currentTeam.sport.id!==1&&<> &middot; <LevelBadge level={LEVEL_NAMES[p.currentTeam.sport.id]||"MiLB"}/></>}
              </div>
            </div>
            {fv && <FVBadge fv={fv}/>}
          </div>;
        })}
      </div>}
    </div>
  );
}

// ── PLAYER CARD ──────────────────────────────────────────────────────────────
function PlayerCard({player}) {
  const [career,setCareer]=useState([]); const [pitchCareer,setPitchCareer]=useState([]); const [loading,setLoading]=useState(true); const [projTab,setProjTab]=useState("war");
  useEffect(()=>{
    setLoading(true);
    setCareer([]);
    setPitchCareer([]);
    const isPitch = player.primaryPosition?.code === "1";
    if (isPitch) {
      getPlayerCareer(player.id, "pitching").then(s=>{setPitchCareer(s);setLoading(false);}).catch(()=>setLoading(false));
    } else {
      getPlayerCareer(player.id, "hitting").then(s=>{setCareer(s);setLoading(false);}).catch(()=>setLoading(false));
    }
  },[player.id]);

  const fv = getPlayerFV(player.id, player.fullName);
  const sc = getStatcast(player.fullName);

  const seasons = useMemo(()=>career.filter(s=>s.stat?.plateAppearances>0).map(s=>{
    const lvl = detectLevel(s);
    return {
      season:s.season, age:player.currentAge-(2025-parseInt(s.season)),
      avg:parseFloat(s.stat.avg||0), obp:parseFloat(s.stat.obp||0), slg:parseFloat(s.stat.slg||0), ops:parseFloat(s.stat.ops||0),
      hr:s.stat.homeRuns||0, pa:s.stat.plateAppearances||0, r:s.stat.runs||0, rbi:s.stat.rbi||0,
      bb:s.stat.baseOnBalls||0, so:s.stat.strikeOuts||0, sb:s.stat.stolenBases||0,
      team:s.team?.abbreviation||"", level:lvl,
    };
  }).sort((a,b)=>{const sy=parseInt(a.season)-parseInt(b.season);if(sy!==0)return sy;return LEVEL_ORDER.indexOf(a.level)-LEVEL_ORDER.indexOf(b.level);}),[career,player]);

  const isPitcher = player.primaryPosition?.code === "1";
  useEffect(()=>{if(isPitcher)setProjTab("war");},[isPitcher]);
  const base = useMemo(() => {
    if (isPitcher) {
      return pitchCareer.length ? projectPitcherFromSeasons(pitchCareer, player.currentAge, player.fullName, player.id) : null;
    }
    return career.length ? projectFromSeasons(career, player.currentAge, player.primaryPosition?.code, player.fullName, player.id) : null;
  }, [career, pitchCareer, player, isPitcher]);
  const forward = useMemo(() => {
    if (!base) return [];
    if (isPitcher) return projectPitcherForward(base, player.currentAge);
    return projectForward(base, player.currentAge, player.primaryPosition?.code);
  }, [base, player, isPitcher]);
  const peak = forward.length?{age:getAP(player.primaryPosition?.code).peak}:null;
  const cWAR = getCareerWAR(player.id, player.fullName);
  const cum = forward.reduce((s,d)=>s+Math.max(0,d.war),0);
  const isMiLB = seasons.length>0 && !seasons.some(s=>s.level==="MLB");

  const opsTrajectory = useMemo(()=>
    projectOPSTrajectory(seasons, base, player.currentAge, player.primaryPosition?.code, player.fullName)
  ,[seasons, base, player]);

  if(loading) return <Spinner msg="Pulling career stats from MLB Stats API..."/>;

  return (
    <div style={{display:"flex",flexDirection:"column",gap:14}}>
      {/* Header */}
      <Panel>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:12}}>
          <div>
            <div style={{display:"flex",alignItems:"center",gap:10}}>
              <h2 style={{margin:0,fontSize:22,fontWeight:800,color:C.text,fontFamily:F}}>{player.fullName}</h2>
              {fv && <FVBadge fv={fv}/>}
              {!fv && isMiLB && <LevelBadge level={base?.highestLevel||"MiLB"}/>}
            </div>
            <p style={{margin:"3px 0 0",fontSize:12,color:C.dim,fontFamily:F}}>
              {posLabel(player.primaryPosition?.code)} &middot; {player.currentTeam?.name||"Free Agent"} &middot; Age {player.currentAge}
              {isPitcher?(player.pitchHand?.code?` \u00b7 Throws: ${player.pitchHand.code}`:""):(player.batSide?.code?` \u00b7 Bats: ${player.batSide.code}`:"")}
              {player.height?` \u00b7 ${player.height}`:""}
              {player.weight?` / ${player.weight} lbs`:""}
            </p>
          </div>
          <div className="via-stat-row" style={{display:"flex",gap:6,flexWrap:"wrap"}}>
            {base&&isPitcher&&<>
            <div className="via-stat-row" style={{display:"flex",gap:6,flexWrap:"wrap"}}>
              <Stat label="Proj ERA" value={base.era?.toFixed(2)} color={base.era<=3.00?C.green:base.era<=3.80?C.blue:base.era<=4.50?C.text:C.accent}/>
              <Stat label="Proj FIP" value={base.fip?.toFixed(2)} color={base.fip<=3.00?C.green:base.fip<=3.80?C.blue:base.fip<=4.50?C.text:C.accent}/>
              <Stat label="Proj WHIP" value={base.whip?.toFixed(2)} color={base.whip<=1.05?C.green:base.whip<=1.20?C.blue:base.whip<=1.35?C.text:C.accent}/>
              <Stat label="Proj K/9" value={base.k9?.toFixed(1)} color={base.k9>=10?C.green:base.k9>=8.5?C.blue:C.text}/>
              <Stat label="Proj IP" value={base.ip} color={base.ip>=180?C.green:base.ip>=140?C.blue:C.text}/>
              <Stat label="Proj WAR" value={base.baseWAR?.toFixed(1)} color={base.baseWAR>=5?C.green:base.baseWAR>=3?C.blue:base.baseWAR>=1?C.purple:C.text}/>
              {cWAR!==null&&<Stat label="Career fWAR" value={cWAR.toFixed(1)} color={cWAR>=30?C.green:cWAR>=15?C.blue:C.purple}/>}
              {peak&&<Stat label="Peak Age" value={peak.age} color={C.cyan}/>}
            </div>
          </>}
          {base&&!isPitcher&&<>
              <Stat label="Proj WAR" value={base.baseWAR.toFixed(1)} color={base.baseWAR>=4?C.green:base.baseWAR>=2?C.blue:C.yellow}/>
              <Stat label="Proj wRC+" value={base.wRCPlus} color={base.wRCPlus>=120?C.green:base.wRCPlus>=100?C.blue:C.yellow}/>
              <Stat label="Proj OPS" value={base.ops.toFixed(3)} color={base.ops>=.85?C.green:base.ops>=.73?C.blue:C.yellow}/>
              {peak&&<Stat label="Peak Age" value={peak.age} color={C.cyan}/>}
              {cWAR!==null&&<Stat label="Career fWAR" value={cWAR.toFixed(1)} color={cWAR>=30?C.green:cWAR>=15?C.blue:C.purple} sub="FanGraphs"/>}
              <Stat label="10yr WAR" value={cum.toFixed(1)} color={C.purple} sub="Projected"/>
            </>}
          </div>
        </div>
        {base&&<div style={{marginTop:10,padding:"7px 12px",background:`${isMiLB?C.purple:C.accent}08`,borderRadius:6,border:`1px solid ${isMiLB?C.purple:C.accent}15`}}>
          <span style={{fontSize:10,color:C.muted,fontFamily:F}}>
            {base.paReliability}% reliability &middot; {isPitcher ? pitchCareer.filter(s=>parseFloat(s.stat?.inningsPitched||0)>0).length : seasons.length} seasons &middot; Marcel 5/4/3 weighting
            {base.translationNote&&<span style={{color:LEVEL_COLORS[base.highestLevel]}}> &middot; {base.translationNote}</span>}
          </span>
        </div>}
      </Panel>

      {/* Statcast Batted Ball Data (if available) */}
      {sc && !isPitcher && <Panel title="BATTED BALL DATA" sub="Statcast metrics from most recent MiLB TrackMan data.">
        <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
          <Stat label="Avg EV" value={`${sc.avgEV}`} sub="mph" color={sc.avgEV>=90?C.green:sc.avgEV>=87?C.blue:C.muted}/>
          <Stat label="Max EV" value={`${sc.maxEV}`} sub="mph" color={sc.maxEV>=108?C.green:sc.maxEV>=104?C.blue:C.muted}/>
          <Stat label="Barrel%" value={`${sc.barrelPct}`} sub="%" color={sc.barrelPct>=12?C.green:sc.barrelPct>=8?C.blue:C.muted}/>
        </div>
      </Panel>}

      {/* Projections — single values per year */}
      {forward.length>0&&<>
        <div style={{display:"flex",gap:4,background:"#efe9dd",borderRadius:8,padding:3,width:"fit-content"}}>
          {(isPitcher?[{k:"war",l:"WAR"}]:[{k:"war",l:"WAR"},{k:"wrc",l:"wRC+"},{k:"ops",l:"OPS"}]).map(t=><Pill key={t.k} label={t.l} active={projTab===t.k} onClick={()=>setProjTab(t.k)}/>)}
        </div>
        <Panel title={`PROJECTED ${projTab.toUpperCase()}`} sub={`Marcel projection${base?.translationNote?` with ${base.highestLevel} translation`:""} + position-specific aging.`}>
          <ResponsiveContainer width="100%" height={280}>
            <ComposedChart data={forward.slice(0,6)} margin={{top:10,right:20,left:0,bottom:0}}>
              <CartesianGrid strokeDasharray="3 3" stroke={C.grid}/>
              <XAxis dataKey="season" stroke={C.muted} fontSize={10} fontFamily={F}/>
              <YAxis stroke={C.muted} fontSize={10} fontFamily={F}/>
              <Tooltip content={<Tip/>}/>
              {projTab==="war"&&<>
                <Bar dataKey="war" name="WAR" radius={[4,4,0,0]} barSize={28}>
                  {forward.slice(0,6).map((d,i)=><Cell key={i} fill={d.war>=4?C.green:d.war>=2?C.blue:d.war>=0?C.yellow:C.red} fillOpacity={.75}/>)}
                </Bar>
                <ReferenceLine y={0} stroke={C.muted} strokeDasharray="5 5"/>
                <ReferenceLine y={2} stroke={C.green} strokeDasharray="3 3" strokeOpacity={.3}/>
              </>}
              {projTab==="wrc"&&!isPitcher&&<>
                <Bar dataKey="wrcPlus" name="wRC+" radius={[4,4,0,0]} barSize={28}>
                  {forward.slice(0,6).map((d,i)=><Cell key={i} fill={d.wrcPlus>=120?C.green:d.wrcPlus>=100?C.blue:C.yellow} fillOpacity={.75}/>)}
                </Bar>
                <ReferenceLine y={100} stroke={C.muted} strokeDasharray="5 5"/>
              </>}
              {projTab==="ops"&&!isPitcher&&<>
                <Bar dataKey="ops" name="OPS" radius={[4,4,0,0]} barSize={28}>
                  {forward.slice(0,6).map((d,i)=><Cell key={i} fill={d.ops>=.850?C.green:d.ops>=.720?C.blue:C.yellow} fillOpacity={.75}/>)}
                </Bar>
                <ReferenceLine y={.720} stroke={C.muted} strokeDasharray="5 5"/>
              </>}
            </ComposedChart>
          </ResponsiveContainer>
        </Panel>
      </>}

      {/* OPS Trajectory — historical + 3 projected seasons */}
      {!isPitcher&&opsTrajectory.length>=2&&<Panel title="OPS TRAJECTORY" sub="Historical performance + 3-year projection using aging curves and batted ball data.">
        <ResponsiveContainer width="100%" height={220}>
          <ComposedChart data={opsTrajectory} margin={{top:10,right:20,left:0,bottom:0}}>
            <CartesianGrid strokeDasharray="3 3" stroke={C.grid}/>
            <XAxis dataKey="season" stroke={C.muted} fontSize={10} fontFamily={F}/>
            <YAxis stroke={C.muted} fontSize={10} fontFamily={F}/>
            <Tooltip content={<Tip/>}/>
            <ReferenceLine y={.720} stroke={C.muted} strokeDasharray="5 5"/>
            <Bar dataKey="ops" radius={[3,3,0,0]} name="OPS" barSize={22}>
              {opsTrajectory.map((s,i)=><Cell key={i} fill={s.type==="projected"?C.accent:LEVEL_COLORS[s.level]||C.accent} fillOpacity={s.type==="projected"?.5:.7}/>)}
            </Bar>
          </ComposedChart>
        </ResponsiveContainer>
        <div style={{display:"flex",gap:10,marginTop:8,flexWrap:"wrap"}}>
          {Object.entries(LEVEL_COLORS).map(([k,v])=><span key={k} style={{fontSize:9,color:v,fontFamily:F}}>&#9632; {k}</span>)}
        </div>
      </Panel>}

      {/* Translation factors (MiLB only) */}
      {isMiLB&&<Panel title="MINOR LEAGUE TRANSLATION FACTORS" sub="How stats at each level translate to MLB equivalents. Lower levels get heavier regression to the mean.">
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(130px,1fr))",gap:6}}>
          {LEVEL_ORDER.map(lvl=>{const t=LEVEL_TRANSLATION[lvl];return(
            <div key={lvl} style={{padding:"10px 12px",background:`${LEVEL_COLORS[lvl]}08`,border:`1px solid ${LEVEL_COLORS[lvl]}${base?.highestLevel===lvl?"40":"15"}`,borderRadius:6}}>
              <div style={{fontSize:14,fontWeight:800,color:LEVEL_COLORS[lvl],fontFamily:F}}>{lvl}</div>
              <div style={{fontSize:9,color:C.muted,fontFamily:F,marginTop:4}}>Factor: <span style={{color:C.text}}>{Math.round(t.factor*100)}%</span></div>
              <div style={{fontSize:9,color:C.muted,fontFamily:F}}>wRC+ adj: <span style={{color:C.text}}>{t.wrcAdj}</span></div>
              <div style={{fontSize:9,color:C.muted,fontFamily:F}}>Reliability: <span style={{color:C.text}}>{Math.round(t.reliability*100)}%</span></div>
            </div>
          );})}
        </div>
      </Panel>}

      {/* Career Stats — moved to bottom */}
      {seasons.length>0&&<Panel title="CAREER STATS" sub={isMiLB?"Minor league stats shown with level indicators. Translation factors applied in projections.":"Year-by-year from MLB Stats API."}>
        <div className="via-table-wrap" style={{overflowX:"auto"}}>
          <table style={{width:"100%",borderCollapse:"collapse",fontFamily:F,fontSize:11}}>
            <thead><tr style={{borderBottom:`1px solid ${C.border}`}}>
              {["Year","Age","Tm","Lvl","PA","AVG","OBP","SLG","OPS","HR","R","RBI","BB","SO","SB"].map(h=>
                <th key={h} style={{padding:"5px 7px",textAlign:["Year","Tm","Lvl"].includes(h)?"left":"right",color:C.muted,fontWeight:600,fontSize:9,letterSpacing:".04em"}}>{h}</th>
              )}
            </tr></thead>
            <tbody>{seasons.map((s,i)=>(
              <tr key={i} style={{borderBottom:`1px solid ${C.border}40`,background:i%2===0?"#f5f0e6":"transparent"}}>
                <td style={{padding:"4px 7px",color:C.text,fontWeight:600}}>{s.season}</td>
                <td style={{padding:"4px 7px",color:C.dim,textAlign:"right"}}>{s.age}</td>
                <td style={{padding:"4px 7px",color:C.dim}}>{s.team}</td>
                <td style={{padding:"4px 7px"}}><LevelBadge level={s.level}/></td>
                <td style={{padding:"4px 7px",color:C.text,textAlign:"right"}}>{s.pa}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:s.avg>=.300?C.green:C.text,fontWeight:600}}>{s.avg.toFixed(3)}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:s.obp>=.370?C.green:C.text}}>{s.obp.toFixed(3)}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:s.slg>=.500?C.green:C.text}}>{s.slg.toFixed(3)}</td>
                <td style={{padding:"4px 7px",textAlign:"right",fontWeight:700,color:s.ops>=.900?C.green:s.ops>=.750?C.accent:C.text}}>{s.ops.toFixed(3)}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:s.hr>=20?C.accent:C.text}}>{s.hr}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:C.text}}>{s.r}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:C.text}}>{s.rbi}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:C.dim}}>{s.bb}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:C.dim}}>{s.so}</td>
                <td style={{padding:"4px 7px",textAlign:"right",color:s.sb>=15?C.cyan:C.dim}}>{s.sb}</td>
              </tr>
            ))}</tbody>
          </table>
        </div>
      </Panel>}
    </div>
  );
}

// ── ROSTER BROWSER (MLB + MiLB) ─────────────────────────────────────────────
function RosterBrowser({onSelect}) {
  const [teams,setTeams]=useState([]); const [selTeam,setSelTeam]=useState(null);
  const [affiliates,setAffiliates]=useState([]); const [selAffiliate,setSelAffiliate]=useState(null);
  const [roster,setRoster]=useState([]); const [loading,setLoading]=useState(false);
  const [viewLevel,setViewLevel]=useState("MLB");

  useEffect(()=>{getTeams(1).then(setTeams);},[]);

  const pickTeam = (team) => {
    setSelTeam(team); setSelAffiliate(null); setRoster([]); setViewLevel("MLB"); setLoading(true);
    Promise.all([getTeamRoster(team.id), getMiLBAffiliate(team.id)])
      .then(([r, a]) => { setRoster(r); setAffiliates(a); setLoading(false); });
  };

  const pickAffiliate = (aff) => {
    setSelAffiliate(aff); setViewLevel(LEVEL_NAMES[aff.sport?.id]||"MiLB"); setLoading(true);
    getTeamRoster(aff.id).then(r=>{setRoster(r);setLoading(false);});
  };

  const showMLB = () => {
    if(!selTeam) return;
    setSelAffiliate(null); setViewLevel("MLB"); setLoading(true);
    getTeamRoster(selTeam.id).then(r=>{setRoster(r);setLoading(false);});
  };

  return (
    <div style={{display:"flex",flexDirection:"column",gap:14}}>
      <Panel title="SELECT MLB ORGANIZATION">
        <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
          {teams.map(t=><button key={t.id} onClick={()=>pickTeam(t)} style={{
            padding:"4px 10px",fontSize:10,fontWeight:600,fontFamily:F,borderRadius:4,cursor:"pointer",border:"none",
            background:selTeam?.id===t.id?C.accent:"#efe9dd",color:selTeam?.id===t.id?"#000":C.muted,
          }}>{t.abbreviation}</button>)}
        </div>
      </Panel>

      {selTeam&&affiliates.length>0&&<Panel title={`${selTeam.name.toUpperCase()} SYSTEM`} sub="Click a level to browse that affiliate's roster.">
        <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
          <button onClick={showMLB} style={{padding:"6px 14px",borderRadius:6,cursor:"pointer",border:`2px solid ${viewLevel==="MLB"?C.green:C.border}`,background:viewLevel==="MLB"?`${C.green}15`:"transparent",color:viewLevel==="MLB"?C.green:C.muted,fontSize:11,fontWeight:700,fontFamily:F}}>
            MLB &middot; {selTeam.abbreviation}
          </button>
          {affiliates.map(a=>{
            const lvl=LEVEL_NAMES[a.sport?.id]||"MiLB";
            const active=selAffiliate?.id===a.id;
            return <button key={a.id} onClick={()=>pickAffiliate(a)} style={{
              padding:"6px 14px",borderRadius:6,cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:F,
              border:`2px solid ${active?LEVEL_COLORS[lvl]:C.border}`,
              background:active?`${LEVEL_COLORS[lvl]}15`:"transparent",
              color:active?LEVEL_COLORS[lvl]:C.muted,
            }}>{lvl} &middot; {a.shortName||a.abbreviation}</button>;
          })}
        </div>
      </Panel>}

      {loading&&<Spinner msg={`Loading ${viewLevel} roster...`}/>}

      {!loading&&roster.length>0&&<Panel title={`${selAffiliate?.name||selTeam?.name||""} ROSTER`} sub="Click a player to load their projection.">
        <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12}}>
          <LevelBadge level={viewLevel}/>
          <span style={{fontSize:11,color:C.dim,fontFamily:F}}>{roster.filter(r=>r.position?.code!=="1").length} position players</span>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(190px,1fr))",gap:5}}>
          {roster.filter(r=>r.person&&r.position?.code!=="1").map(r=>{
            const rfv = getPlayerFV(r.person.id, r.person.fullName);
            return <div key={r.person.id} onClick={()=>onSelect(r.person)}
              style={{padding:"7px 11px",background:"#efe9dd",borderRadius:6,cursor:"pointer",border:`1px solid ${C.border}`,transition:"border-color .1s",display:"flex",justifyContent:"space-between",alignItems:"center"}}
              onMouseEnter={e=>e.currentTarget.style.borderColor=LEVEL_COLORS[viewLevel]||C.accent}
              onMouseLeave={e=>e.currentTarget.style.borderColor=C.border}>
              <div>
                <div style={{fontSize:12,fontWeight:700,color:C.text,fontFamily:F}}>{r.person.fullName}</div>
                <div style={{fontSize:10,color:C.muted,fontFamily:F}}>{posLabel(r.position?.code)} &middot; #{r.jerseyNumber||"\u2014"}</div>
              </div>
              {rfv && <FVBadge fv={rfv}/>}
            </div>;
          })}
        </div>
      </Panel>}
    </div>
  );
}

// ── LEADERBOARD ─────────────────────────────────────────────────────────────
// Fetches all active MLB position players via the sports_players endpoint,
// pulls 2025 season stats in bulk, runs projections, and shows a sortable table.

async function fetchAllMLBPlayers() {
  const TEAMS = {108:'LAA',109:'AZ',110:'BAL',111:'BOS',112:'CHC',113:'CIN',114:'CLE',115:'COL',116:'DET',117:'HOU',118:'KC',119:'LAD',120:'WSH',121:'NYM',133:'OAK',134:'PIT',135:'SD',136:'SEA',137:'SF',138:'STL',139:'TB',140:'TEX',141:'TOR',142:'MIN',143:'PHI',144:'ATL',145:'CWS',146:'MIA',147:'NYY',158:'MIL'};
  try {
    const allPlayers = [];
    const ids = Object.keys(TEAMS);
    const BATCH = 6;
    for (let i = 0; i < ids.length; i += BATCH) {
      const batch = ids.slice(i, i + BATCH);
      const results = await Promise.all(batch.map(async tid => {
        try {
          const res = await fetch(`${API}/teams/${tid}/roster?rosterType=40Man&season=2026&hydrate=person`);
          const data = await res.json();
          return (data.roster || []).map(r => {
            const p = r.person || {};
            p._teamAbbr = TEAMS[tid];
            return p;
          });
        } catch { return []; }
      }));
      allPlayers.push(...results.flat());
    }
    // Deduplicate by player ID
    const seen = new Set();
    return allPlayers.filter(p => { if (seen.has(p.id)) return false; seen.add(p.id); return true; });
  } catch(e) { console.error(e); return []; }
}

async function fetchPlayerPitchingStats(playerId) {
  const sportIds = [1, 11, 12, 13, 14, 16];
  try {
    const promises = sportIds.map(sid =>
      fetch(`${API}/people/${playerId}/stats?stats=yearByYear&group=pitching&gameType=R&sportId=${sid}`)
        .then(r => r.json())
        .then(d => (d.stats?.[0]?.splits || []).map(s => ({...s, _sportId: sid})))
        .catch(() => [])
    );
    return (await Promise.all(promises)).flat();
  } catch { return []; }
}

async function fetchPlayerSeasonStats(playerId) {
  // Fetch most recent 3 seasons across all levels
  const sportIds = [1, 11, 12, 13, 14, 16];
  try {
    const promises = sportIds.map(sid =>
      fetch(`${API}/people/${playerId}/stats?stats=yearByYear&group=hitting&gameType=R&sportId=${sid}`)
        .then(r => r.json())
        .then(d => (d.stats?.[0]?.splits || []).map(s => ({ ...s, _sportId: sid })))
        .catch(() => [])
    );
    const all = await Promise.all(promises);
    return all.flat();
  } catch { return []; }
}

const PITCHER_COLS = [
  { k: "name",     l: "Player",      fmt: v => v, align: "left", sortDir: 1 },
  { k: "team",     l: "Team",        fmt: v => v, align: "left", sortDir: 1 },
  { k: "age",      l: "Age",         fmt: v => v, align: "right", sortDir: -1 },
  { k: "projWAR",  l: "Proj WAR",    fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: -1 },
  { k: "careerWAR",l: "Career fWAR", fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: -1 },
  { k: "cumWAR",   l: "10yr WAR",    fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: -1 },
  { k: "projERA",  l: "Proj ERA",    fmt: v => v?.toFixed(2) ?? "—", align: "right", sortDir: 1 },
  { k: "projFIP",  l: "Proj FIP",    fmt: v => v?.toFixed(2) ?? "—", align: "right", sortDir: 1 },
  { k: "projWHIP", l: "Proj WHIP",   fmt: v => v?.toFixed(2) ?? "—", align: "right", sortDir: 1 },
  { k: "projK9",   l: "Proj K/9",    fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: -1 },
  { k: "projBB9",  l: "Proj BB/9",   fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: 1 },
  { k: "projIP",   l: "Proj IP",     fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "projW",    l: "Proj W",      fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "projSV",   l: "Proj SV",     fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "lastERA",  l: "'25 ERA",     fmt: v => v?.toFixed(2) ?? "—", align: "right", sortDir: 1 },
  { k: "lastIP",   l: "'25 IP",      fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "lastSO",   l: "'25 SO",      fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "fv",       l: "FV",          fmt: v => v ?? "—", align: "right", sortDir: -1 },
];

const LEADER_COLS = [
  { k: "name",     l: "Player",      fmt: v => v, align: "left", sortDir: 1 },
  { k: "team",     l: "Team",        fmt: v => v, align: "left", sortDir: 1 },
  { k: "pos",      l: "Pos",         fmt: v => v, align: "left", sortDir: 1 },
  { k: "age",      l: "Age",         fmt: v => v, align: "right", sortDir: -1 },
  { k: "projWAR",  l: "Proj WAR",    fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: -1 },
  { k: "careerWAR",l: "Career fWAR",  fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: -1 },
  { k: "cumWAR",   l: "10yr WAR",     fmt: v => v?.toFixed(1) ?? "—", align: "right", sortDir: -1 },
  { k: "projWRC",  l: "Proj wRC+",   fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "projOPS",  l: "Proj OPS",    fmt: v => v?.toFixed(3) ?? "—", align: "right", sortDir: -1 },
  { k: "projAVG",  l: "Proj AVG",    fmt: v => v?.toFixed(3) ?? "—", align: "right", sortDir: -1 },
  { k: "projOBP",  l: "Proj OBP",    fmt: v => v?.toFixed(3) ?? "—", align: "right", sortDir: -1 },
  { k: "projSLG",  l: "Proj SLG",    fmt: v => v?.toFixed(3) ?? "—", align: "right", sortDir: -1 },
  { k: "projHR",   l: "Proj HR",     fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "lastAVG",  l: "'25 AVG",     fmt: v => v?.toFixed(3) ?? "—", align: "right", sortDir: -1 },
  { k: "lastOPS",  l: "'25 OPS",     fmt: v => v?.toFixed(3) ?? "—", align: "right", sortDir: -1 },
  { k: "lastHR",   l: "'25 HR",      fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "lastSB",   l: "'25 SB",      fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "lastPA",   l: "'25 PA",      fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "peakAge",  l: "Peak Age",    fmt: v => v ?? "—", align: "right", sortDir: -1 },
  { k: "fv",       l: "FV",          fmt: v => v ?? "—", align: "right", sortDir: -1 },
];

function Leaderboard({ onSelect }) {
  const [players, setPlayers] = useState([]);
  const [pitchers, setPitchers] = useState([]);
  const [mode, setMode] = useState("hitters");
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState({ done: 0, total: 0 });
  const [sortCol, setSortCol] = useState("projWAR");
  const [sortAsc, setSortAsc] = useState(false);
  const [posFilter, setPosFilter] = useState("ALL");
  const [search, setSearch] = useState("");
  const [started, setStarted] = useState(false);

  const loadAll = useCallback(async () => {
    setStarted(true);
    setLoading(true);
    setPlayers([]);
    setPitchers([]);

    // Step 1: fetch all active MLB players
    const allPeople = await fetchAllMLBPlayers();
    const hitters = allPeople.filter(p => p.primaryPosition?.code !== "1");
    const pitcherList = allPeople.filter(p => p.primaryPosition?.code === "1");
    setProgress({ done: 0, total: hitters.length + pitcherList.length });

    // Step 2: fetch stats and project in batches of 15
    const results = [];
    const BATCH = 15;
    for (let i = 0; i < hitters.length; i += BATCH) {
      const batch = hitters.slice(i, i + BATCH);
      const batchResults = await Promise.all(batch.map(async (p) => {
        try {
          const splits = await fetchPlayerSeasonStats(p.id);
          if (!splits.length) return null;

          const base = projectFromSeasons(splits, p.currentAge, p.primaryPosition?.code, p.fullName, p.id);
          if (!base) return null;

          const forward = projectForward(base, p.currentAge, p.primaryPosition?.code);
          const cum = forward.reduce((s, d) => s + Math.max(0, d.war), 0);
          const fv = getPlayerFV(p.id, p.fullName);

          // Find 2025 stats
          const s25 = splits
            .filter(s => s.season === "2025" && s.stat?.plateAppearances > 0)
            .sort((a, b) => (b.stat?.plateAppearances || 0) - (a.stat?.plateAppearances || 0));
          const best25 = s25[0]?.stat;

          return {
            id: p.id,
            name: p.fullName,
            team: p._teamAbbr || p.currentTeam?.abbreviation || "FA",
            pos: posLabel(p.primaryPosition?.code),
            age: p.currentAge,
            projWAR: base.baseWAR,
            careerWAR: getCareerWAR(p.id, p.fullName),
            cumWAR: Math.round(cum * 10) / 10,
            projWRC: base.wRCPlus,
            projOPS: base.ops,
            projAVG: base.avg,
            projOBP: base.obp,
            projSLG: base.slg,
            projHR: base.hr,
            lastAVG: best25 ? parseFloat(best25.avg || 0) : null,
            lastOPS: best25 ? parseFloat(best25.ops || 0) : null,
            lastHR: best25 ? best25.homeRuns : null,
            lastSB: best25 ? best25.stolenBases : null,
            lastPA: best25 ? best25.plateAppearances : null,
            peakAge: getAP(p.primaryPosition?.code).peak,
            fv: fv,
            _player: p,
          };
        } catch { return null; }
      }));

      const valid = batchResults.filter(Boolean);
      results.push(...valid);
      setPlayers(prev => [...prev, ...valid]);
      setProgress({ done: Math.min(i + BATCH, hitters.length), total: hitters.length + pitcherList.length });
    }

    // Now process pitchers
    try {
    for (let i = 0; i < pitcherList.length; i += BATCH) {
      const batch = pitcherList.slice(i, i + BATCH);
      const batchResults = await Promise.all(batch.map(async p => {
        try {
          const splits = await fetchPlayerPitchingStats(p.id);
          if (!splits.length) return null;
          const base = projectPitcherFromSeasons(splits, p.currentAge, p.fullName, p.id);
          if (!base) return null;
          const fwd = projectPitcherForward(base, p.currentAge);
          const cum = fwd.reduce((s, d) => s + Math.max(0, d.war), 0);
          const last = splits.find(s => s.season === "2025" && s._sportId === 1);
          const lst = last?.stat || {};
          return {
            id: p.id, name: p.fullName, fullData: p,
            team: p._teamAbbr || p.currentTeam?.abbreviation || "FA",
            pos: base.isReliever ? "RP" : "SP", age: p.currentAge,
            projWAR: base.baseWAR, careerWAR: getCareerWAR(p.id, p.fullName),
            cumWAR: Math.round(cum * 10) / 10,
            projERA: base.era, projFIP: base.fip, projWHIP: base.whip,
            projK9: base.k9, projBB9: base.bb9, projIP: base.ip,
            projW: base.w, projSV: base.sv,
            lastERA: lst.era ? parseFloat(lst.era) : null,
            lastIP: lst.inningsPitched ? parseFloat(lst.inningsPitched) : null,
            lastSO: lst.strikeOuts ? parseInt(lst.strikeOuts) : null,
            fv: getPlayerFV(p.id, p.fullName),
          };
        } catch { return null; }
      }));
      setPitchers(prev => [...prev, ...batchResults.filter(Boolean)]);
      setProgress({ done: results.length + i + BATCH, total: hitters.length + pitcherList.length });
    }
    } catch(e) { console.error("Pitcher loading error:", e); }

    setLoading(false);
  }, []);

  const sorted = useMemo(() => {
    let filtered = (mode === "pitchers" ? pitchers : players);
    if (posFilter !== "ALL") filtered = filtered.filter(p => p.pos === posFilter);
    if (search) {
      const q = search.toLowerCase();
      filtered = filtered.filter(p => p.name.toLowerCase().includes(q) || p.team.toLowerCase().includes(q));
    }
    const activeCols = mode === "pitchers" ? PITCHER_COLS : LEADER_COLS;
    const col = activeCols.find(c => c.k === sortCol);
    const dir = sortAsc ? 1 : -1;
    return [...filtered].sort((a, b) => {
      const av = a[sortCol], bv = b[sortCol];
      if (av == null && bv == null) return 0;
      if (av == null) return 1;
      if (bv == null) return -1;
      if (typeof av === "string") return av.localeCompare(bv) * dir;
      return (av - bv) * dir;
    });
  }, [players, pitchers, mode, sortCol, sortAsc, posFilter, search]);

  const toggleSort = (k) => {
    if (sortCol === k) setSortAsc(!sortAsc);
    else { setSortCol(k); setSortAsc(false); }
  };

  const positions = ["ALL", "C", "1B", "2B", "3B", "SS", "LF", "CF", "RF", "DH", "OF"];
  const pitcherPositions = ["ALL", "SP", "RP"];

  if (!started) {
    return (
      <Panel style={{ textAlign: "center", padding: 50 }}>
        <div style={{ fontSize: 44, marginBottom: 12 }}>&#128202;</div>
        <h3 style={{ margin: 0, fontSize: 16, color: C.text, fontFamily: F }}>MLB Leaderboard</h3>
        <p style={{ margin: "8px auto 0", fontSize: 12, color: C.muted, fontFamily: F, maxWidth: 520, lineHeight: 1.6 }}>
          Load every active MLB position player, run projections on all of them, and sort by any stat.
          This fetches ~400+ players from the MLB Stats API — takes about 60-90 seconds.
        </p>
        <button onClick={loadAll} style={{
          marginTop: 20, padding: "10px 28px", borderRadius: 8, border: "none", cursor: "pointer",
          background: C.accent, color: "#fff", fontSize: 13, fontWeight: 700, fontFamily: F,
        }}>Load All Players &amp; Project</button>
      </Panel>
    );
  }

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
      {/* Progress */}
      {loading && <Panel>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{ width: 16, height: 16, border: `2px solid ${C.border}`, borderTopColor: C.accent, borderRadius: "50%", animation: "spin .8s linear infinite" }} />
          <span style={{ fontSize: 12, color: C.dim, fontFamily: F }}>
            Loading players... {progress.done}/{progress.total} ({players.length} hitters, {pitchers.length} pitchers projected)
          </span>
        </div>
        <div style={{ marginTop: 8, height: 4, background: C.border, borderRadius: 2, overflow: "hidden" }}>
          <div style={{ height: "100%", background: C.accent, borderRadius: 2, width: `${progress.total ? (progress.done / progress.total) * 100 : 0}%`, transition: "width .3s" }} />
        </div>
      </Panel>}

      {/* Filters */}
      {(players.length > 0 || pitchers.length > 0) && <Panel>
        <div className="via-mode-toggle" style={{display:"flex",gap:4,marginBottom:10}}>
          <button onClick={()=>{setMode("hitters");setSortCol("projWAR");setSortAsc(false);setPosFilter("ALL");}}
            style={{padding:"6px 16px",border:"none",cursor:"pointer",fontSize:11,fontWeight:mode==="hitters"?700:500,fontFamily:F,
              background:mode==="hitters"?C.navy:"transparent",color:mode==="hitters"?"#fff":C.muted,borderRadius:6}}>Hitters</button>
          <button onClick={()=>{setMode("pitchers");setSortCol("projWAR");setSortAsc(false);setPosFilter("ALL");}}
            style={{padding:"6px 16px",border:"none",cursor:"pointer",fontSize:11,fontWeight:mode==="pitchers"?700:500,fontFamily:F,
              background:mode==="pitchers"?C.navy:"transparent",color:mode==="pitchers"?"#fff":C.muted,borderRadius:6}}>Pitchers</button>
        </div>
        <div className="via-leaderboard-filters" style={{ display: "flex", gap: 12, alignItems: "center", flexWrap: "wrap" }}>
          <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Filter by name or team..."
            style={{ padding: "6px 12px", borderRadius: 6, border: `1px solid ${C.border}`, background: C.panel, color: C.text, fontSize: 11, fontFamily: F, outline: "none", width: 200 }} />
          <div className="via-pos-filters" style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>
            {(mode === "pitchers" ? pitcherPositions : positions).map(p => (
              <button key={p} onClick={() => setPosFilter(p)} style={{
                padding: "4px 10px", fontSize: 10, fontWeight: 600, fontFamily: F, borderRadius: 4, cursor: "pointer", border: "none",
                background: posFilter === p ? C.accent : "#efe9dd", color: posFilter === p ? "#fff" : C.muted,
              }}>{p}</button>
            ))}
          </div>
          <span style={{ fontSize: 10, color: C.muted, fontFamily: F, marginLeft: "auto" }}>{sorted.length} players</span>
        </div>
      </Panel>}

      {/* Table */}
      {(players.length > 0 || pitchers.length > 0) && <Panel>
        <div style={{ overflowX: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontFamily: F, fontSize: 10 }}>
            <thead>
              <tr style={{ borderBottom: `2px solid ${C.border}` }}>
                <th style={{ padding: "6px 4px", textAlign: "right", color: C.muted, fontWeight: 600, fontSize: 8, width: 30 }}>#</th>
                {(mode === "pitchers" ? PITCHER_COLS : LEADER_COLS).map(col => (
                  <th key={col.k} onClick={() => toggleSort(col.k)} style={{
                    padding: "6px 6px", textAlign: col.align, color: sortCol === col.k ? C.accent : C.muted,
                    fontWeight: 600, fontSize: 8, letterSpacing: ".04em", cursor: "pointer", userSelect: "none", whiteSpace: "nowrap",
                  }}>
                    {col.l} {sortCol === col.k ? (sortAsc ? "▲" : "▼") : ""}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {sorted.slice(0, 200).map((p, i) => (
                <tr key={p.id}
                  onClick={() => onSelect(p._player)}
                  style={{
                    borderBottom: `1px solid ${C.border}40`,
                    background: i % 2 === 0 ? "#f5f0e6" : "transparent",
                    cursor: "pointer",
                  }}
                  onMouseEnter={e => e.currentTarget.style.background = `${C.accent}08`}
                  onMouseLeave={e => e.currentTarget.style.background = i % 2 === 0 ? "#f5f0e6" : "transparent"}>
                  <td style={{ padding: "5px 4px", textAlign: "right", color: C.muted, fontSize: 9 }}>{i + 1}</td>
                  {(mode === "pitchers" ? PITCHER_COLS : LEADER_COLS).map(col => {
                    const val = p[col.k];
                    const display = col.fmt(val);
                    let color = C.text;
                    if (col.k === "projWAR") color = val >= 4 ? C.green : val >= 2 ? C.blue : val >= 0 ? C.text : C.red;
                    if (col.k === "projOPS") color = val >= .850 ? C.green : val >= .720 ? C.blue : C.text;
                    if (col.k === "projWRC") color = val >= 120 ? C.green : val >= 100 ? C.blue : C.text;
                    if (col.k === "fv" && val) color = val >= 60 ? C.accent : val >= 50 ? C.yellow : C.muted;
                    if (col.k === "name") color = C.text;
                    return (
                      <td key={col.k} style={{
                        padding: "5px 6px", textAlign: col.align, color,
                        fontWeight: col.k === "name" || col.k === "projWAR" || col.k === "projOPS" ? 700 : 400,
                        whiteSpace: "nowrap",
                      }}>{display}</td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {sorted.length > 200 && <p style={{ fontSize: 10, color: C.muted, fontFamily: F, marginTop: 8, textAlign: "center" }}>Showing top 200 of {sorted.length}. Use filters to narrow.</p>}
      </Panel>}
    </div>
  );
}

// ── AGING CURVES ─────────────────────────────────────────────────────────────
function AgingPanel() {
  const [sel,setSel]=useState(["SS","CF","1B","C"]); const [bw,setBw]=useState(4);
  const posC = {C:C.red,"1B":C.yellow,"2B":C.green,"3B":C.accent,SS:C.blue,LF:C.purple,CF:C.cyan,RF:C.pink,DH:C.muted};
  const data=useMemo(()=>{
    const m={};
    sel.forEach(pos=>{const p=AGING_PARAMS[pos];for(let age=20;age<=40;age++){if(!m[age])m[age]={age};const d=age-p.peak;const off=d<=0?1-.015*d*d*.3:1-p.dr*d*d*.25;const def=age<=p.peak?1:1-p.dd*(age-p.peak);m[age][pos]=Math.round(Math.max(-.5,bw*off*Math.max(.4,def)+p.pa/10*Math.max(.3,def))*10)/10;}});
    return Object.values(m).sort((a,b)=>a.age-b.age);
  },[sel,bw]);
  return (
    <Panel title="POSITION AGING CURVES" sub="Offensive (quadratic) + defensive (linear) decline.">
      <div style={{display:"flex",flexWrap:"wrap",gap:5,marginBottom:14}}>
        {Object.keys(AGING_PARAMS).map(pos=><button key={pos} onClick={()=>setSel(p=>p.includes(pos)?p.filter(x=>x!==pos):[...p,pos])} style={{padding:"5px 12px",borderRadius:5,cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:F,border:`2px solid ${sel.includes(pos)?posC[pos]:C.border}`,background:sel.includes(pos)?`${posC[pos]}18`:"transparent",color:sel.includes(pos)?posC[pos]:C.muted}}>{pos}</button>)}
        <div style={{marginLeft:"auto",display:"flex",alignItems:"center",gap:8}}>
          <span style={{fontSize:10,color:C.muted,fontFamily:F}}>BASE WAR</span>
          <input type="range" min="1" max="8" step=".5" value={bw} onChange={e=>setBw(+e.target.value)} style={{width:100,accentColor:C.accent}}/>
          <span style={{fontSize:13,fontWeight:700,color:C.accent,fontFamily:F}}>{bw}</span>
        </div>
      </div>
      <ResponsiveContainer width="100%" height={360}>
        <LineChart data={data} margin={{top:10,right:30,left:0,bottom:0}}>
          <CartesianGrid strokeDasharray="3 3" stroke={C.grid}/><XAxis dataKey="age" stroke={C.muted} fontSize={10} fontFamily={F}/><YAxis stroke={C.muted} fontSize={10} fontFamily={F}/><Tooltip content={<Tip/>}/><ReferenceLine y={0} stroke={C.muted} strokeDasharray="5 5"/>
          {sel.map(pos=><Line key={pos} type="monotone" dataKey={pos} stroke={posC[pos]} strokeWidth={2.5} dot={false} name={pos}/>)}
        </LineChart>
      </ResponsiveContainer>
    </Panel>
  );
}

// ── METHODOLOGY ──────────────────────────────────────────────────────────────
function VpDPanel() {
  const [loading, setLoading] = useState(true);
  const [players, setPlayers] = useState([]);
  const [sort, setSort] = useState({ key: "warPerM", dir: -1 });
  const [contractData, setContractData] = useState({});


  function getVpdGrade(warPerM) {
    if (warPerM >= 0.25) return { grade: "A+", color: "#10b981", label: "Elite Value" };
    if (warPerM >= 0.20) return { grade: "A", color: "#22c55e", label: "Excellent" };
    if (warPerM >= 0.15) return { grade: "B", color: "#eab308", label: "Good" };
    if (warPerM >= 0.12) return { grade: "C+", color: "#f59e0b", label: "Above Avg" };
    if (warPerM >= 0.10) return { grade: "C", color: "#64748b", label: "Fair" };
    if (warPerM >= 0.075) return { grade: "D", color: "#ef4444", label: "Below Avg" };
    return { grade: "F", color: "#dc2626", label: "Overpaid" };
  function getVpdGrade(warPerM) {
    if (warPerM >= 2.00) return { grade: "A+", color: "#10b981", label: "Elite" };
    if (warPerM >= 1.00) return { grade: "A", color: "#22c55e", label: "Excellent" };
    if (warPerM >= 0.60) return { grade: "A-", color: "#84cc16", label: "Great" };
    if (warPerM >= 0.40) return { grade: "B+", color: "#eab308", label: "Very Good" };
    if (warPerM >= 0.25) return { grade: "B", color: "#f59e0b", label: "Good" };
    if (warPerM >= 0.18) return { grade: "B-", color: "#fb923c", label: "Above Avg" };
    if (warPerM >= 0.13) return { grade: "C+", color: "#fbbf24", label: "Fair" };
    if (warPerM >= 0.10) return { grade: "C", color: "#94a3b8", label: "Below Avg" };
    if (warPerM >= 0.07) return { grade: "D", color: "#ef4444", label: "Poor Value" };
    return { grade: "F", color: "#dc2626", label: "Overpaid" };
  }
  }

  useEffect(() => {
    async function loadData() {
      try {
        const contracts = await import("./contract_data.json");
        setContractData(contracts.default || contracts);
        
        const playerPromises = Object.keys(contracts.default || contracts).filter(name => (contracts.default || contracts)[name] > 800000).map(async (name) => {
          try {
            const results = await searchPlayers(name);
            if (results && results[0]) {
              const player = await getPlayerStats(results[0].id);
              if (!player) return null;
              const isPitcher = player.primaryPosition?.code === "1";
              const career = await getPlayerCareer(player.id, isPitcher ? "pitching" : "hitting");
              let base;
              if (isPitcher) {
                base = projectPitcherFromSeasons(career.filter(s => parseFloat(s.stat?.inningsPitched || 0) > 0), player.currentAge, player.fullName, player.id);
              } else {
                const splits = career.filter(s => s.stat?.plateAppearances > 0);
                base = projectFromSeasons(splits, player.currentAge, player.primaryPosition?.code, player.fullName, player.id);
              }
              
              if (base && base.baseWAR) {
                const salary = (contracts.default || contracts)[name];
                return {
                  name: player.fullName,
                  salary: salary,
                  war: base.baseWAR,
                  warPerM: base.baseWAR / (salary / 1000000),
                  pos: player.primaryPosition?.code,
                  team: player.currentTeam?.abbreviation || player.currentTeam?.name || "FA"
                };
              }
            }
          } catch (e) {
            console.error(`Failed to load ${name}:`, e);
          }
          return null;
        });
        const results = await Promise.all(playerPromises);
        const validResults = results.filter(Boolean);
        const top100 = validResults.sort((a, b) => b.vpd - a.vpd).slice(0, 100);
        setPlayers(top100);
        setLoading(false);
      } catch (e) {
        console.error("Failed to load contract data:", e);
        setLoading(false);
      }
    }
    loadData();
  }, []);

  const sorted = useMemo(() => {
    return [...players].sort((a, b) => {
      const aVal = a[sort.key];
      const bVal = b[sort.key];
      if (typeof aVal === "string") return aVal.localeCompare(bVal) * sort.dir;
      return (aVal - bVal) * sort.dir;
    });
  }, [players, sort]);

  return (
    <div>
      <Panel title="VALUE PER DOLLAR (VpD)" sub="Most cost-efficient players based on projected WAR vs. 2026 salary">
        {loading && <Spinner msg="Loading contract data and projections..."/>}
        {!loading && players.length === 0 && <p style={{color:C.muted,fontSize:11,fontFamily:F}}>No data available</p>}
        {!loading && players.length > 0 && (
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,fontFamily:F}}>
              <thead><tr>
                <th style={{padding:"8px",borderBottom:`2px solid ${C.border}`,textAlign:"left",cursor:"pointer",fontWeight:700,color:C.muted,fontSize:9}} onClick={() => setSort({key:"name",dir:sort.key==="name"?-sort.dir:-1})}>PLAYER</th>
                <th style={{padding:"8px",borderBottom:`2px solid ${C.border}`,textAlign:"center",cursor:"pointer",fontWeight:700,color:C.muted,fontSize:9}} onClick={() => setSort({key:"pos",dir:sort.key==="pos"?-sort.dir:-1})}>POS</th>
                <th style={{padding:"8px",borderBottom:`2px solid ${C.border}`,textAlign:"center",cursor:"pointer",fontWeight:700,color:C.muted,fontSize:9}} onClick={() => setSort({key:"team",dir:sort.key==="team"?-sort.dir:-1})}>TEAM</th>
                <th style={{padding:"8px",borderBottom:`2px solid ${C.border}`,textAlign:"right",cursor:"pointer",fontWeight:700,color:C.muted,fontSize:9}} onClick={() => setSort({key:"war",dir:sort.key==="war"?-sort.dir:-1})}>PROJ WAR</th>
                <th style={{padding:"8px",borderBottom:`2px solid ${C.border}`,textAlign:"right",cursor:"pointer",fontWeight:700,color:C.muted,fontSize:9}} onClick={() => setSort({key:"salary",dir:sort.key==="salary"?-sort.dir:-1})}>2026 SALARY</th>
                <th style={{padding:"8px",borderBottom:`2px solid ${C.border}`,textAlign:"right",cursor:"pointer",fontWeight:700,color:C.muted,fontSize:9}} onClick={() => setSort({key:"vpd",dir:sort.key==="vpd"?-sort.dir:-1})}>VpD GRADE</th>
              </tr></thead>
              <tbody>
                {sorted.map((p, i) => (
                  <tr key={i} style={{borderBottom:`1px solid ${C.border}22`}}>
                    <td style={{padding:"8px",fontWeight:600,color:C.text}}>{p.name}</td>
                    <td style={{padding:"8px",textAlign:"center",color:C.muted,fontSize:10}}>{posLabel(p.pos) || "—"}</td>
                    <td style={{padding:"8px",textAlign:"center",color:C.muted,fontSize:10}}>{p.team || "—"}</td>
                    <td style={{padding:"8px",textAlign:"right",color:C.accent,fontWeight:600}}>{p.war.toFixed(1)}</td>
                    <td style={{padding:"8px",textAlign:"right",color:C.text}}>${(p.salary/1000000).toFixed(1)}M</td>
                    <td style={{padding:"8px",textAlign:"center"}}>{
                      (() => {
                        const g = getVpdGrade(p.warPerM);
                        return <span style={{display:"inline-block",padding:"2px 8px",borderRadius:4,background:`${g.color}20`,color:g.color,fontWeight:700,fontSize:11}}>{g.grade}</span>;
                      })()
                    }</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </Panel>
    </div>
  );
}

function CardMarketplace({ onSelect }) {
  const [search, setSearch] = useState("");
  const [searchResults, setSearchResults] = useState([]);
  const [selectedPlayer, setSelectedPlayer] = useState(null);
  const [projection, setProjection] = useState(null);
  const [loadingPlayer, setLoadingPlayer] = useState(false);
  const [cardType, setCardType] = useState("RC");
  const [psaGrade, setPsaGrade] = useState("raw");
  const [parallel, setParallel] = useState("base");
  const [currentPrice, setCurrentPrice] = useState("");
  const [showProjection, setShowProjection] = useState(false);

  const CARD_TYPES = [
    { k: "RC", l: "Rookie Card" },
    { k: "auto", l: "Auto" },
    { k: "auto_rc", l: "Auto RC" },
    { k: "base", l: "Base" },
    { k: "refractor", l: "Refractor" },
  ];

  const PSA_GRADES = [
    { k: "raw", l: "Raw", mult: 1.0 },
    { k: "psa8", l: "PSA 8", mult: 1.8 },
    { k: "psa9", l: "PSA 9", mult: 3.2 },
    { k: "psa10", l: "PSA 10", mult: 7.5 },
    { k: "bgs95", l: "BGS 9.5", mult: 5.0 },
    { k: "bgs10", l: "BGS 10", mult: 12.0 },
  ];

  const PARALLELS = [
    { k: "base", l: "Base", mult: 1.0 },
    { k: "prizm_silver", l: "Prizm Silver", mult: 2.5 },
    { k: "prizm_color", l: "Prizm Color", mult: 4.0 },
    { k: "optic", l: "Optic", mult: 1.8 },
    { k: "superfractor", l: "Superfractor 1/1", mult: 25.0 },
    { k: "numbered_25", l: "/25 Numbered", mult: 8.0 },
    { k: "numbered_10", l: "/10 Numbered", mult: 15.0 },
    { k: "auto_card", l: "Auto Variation", mult: 5.0 },
  ];

  const CARD_TYPE_MULT = { RC: 1.0, auto: 3.5, auto_rc: 6.0, base: 0.4, refractor: 1.8 };

  useEffect(() => {
    if (!search.trim()) { setSearchResults([]); return; }
    const t = setTimeout(() => {
      searchPlayers(search).then(r => setSearchResults(r.slice(0, 6)));
    }, 300);
    return () => clearTimeout(t);
  }, [search]);

  const selectPlayer = async (p) => {
    setSearch("");
    setSearchResults([]);
    setLoadingPlayer(true);
    setShowProjection(false);
    try {
      const full = await getPlayerStats(p.id);
      const player = full || p;
      const isPitcher = player.primaryPosition?.code === "1";
      const career = await getPlayerCareer(player.id, isPitcher ? "pitching" : "hitting");
      let base, forward;
      if (isPitcher) {
        base = projectPitcherFromSeasons(career.filter(s => parseFloat(s.stat?.inningsPitched || 0) > 0), player.currentAge, player.fullName, player.id);
        forward = base ? projectPitcherForward(base, player.currentAge) : [];
      } else {
        const splits = career.filter(s => s.stat?.plateAppearances > 0);
        base = projectFromSeasons(splits, player.currentAge, player.primaryPosition?.code, player.fullName, player.id);
        forward = base ? projectForward(base, player.currentAge, player.primaryPosition?.code) : [];
      }
      const fv = getPlayerFV(player.id, player.fullName);
      setSelectedPlayer({ ...player, fv });
      setProjection({ base, forward });
    } catch(e) { console.error(e); }
    setLoadingPlayer(false);
  };

  const projectCardValue = () => {
    if (!projection || !currentPrice) return null;
    const price = parseFloat(currentPrice);
    if (isNaN(price) || price <= 0) return null;

    const psaMult = PSA_GRADES.find(g => g.k === psaGrade)?.mult || 1;
    const parallelMult = PARALLELS.find(p => p.k === parallel)?.mult || 1;
    const typeMult = CARD_TYPE_MULT[cardType] || 1;
    const fvBonus = selectedPlayer?.fv ? (selectedPlayer.fv >= 70 ? 2.5 : selectedPlayer.fv >= 65 ? 2.0 : selectedPlayer.fv >= 60 ? 1.6 : selectedPlayer.fv >= 55 ? 1.3 : 1.1) : 1.0;

    const baseWAR = projection.base?.baseWAR || 0;
    const peakWAR = projection.forward?.length ? Math.max(...projection.forward.map(f => f?.war || 0)) : baseWAR;

    return (projection.forward || []).slice(0, 6).map((f, i) => {
      if (!f) return null;
      const yr = 2026 + i;
      const war = f.war || 0;

      // Exponential star premium - WAR > 4 gets huge multiplier
      const warMult = war <= 0 ? 0.5 :
        war < 2 ? 0.7 + war * 0.15 :
        war < 4 ? 1.0 + (war - 2) * 0.3 :
        war < 6 ? 1.6 + Math.pow(war - 4, 1.8) * 0.8 :
        1.6 + Math.pow(war - 4, 1.8) * 0.8 + Math.pow(war - 6, 2) * 1.2;

      // Peak proximity bonus - cards peak in value ~1yr before player peaks
      const isPeakYear = Math.abs(war - peakWAR) < 0.3;
      const peakBonus = isPeakYear ? 1.25 : 1.0;

      // FV prospect premium decays as player proves themselves
      const fvDecay = Math.max(1.0, fvBonus - i * 0.15);

      const projectedPrice = price * warMult * peakBonus * fvDecay;

      return {
        year: yr,
        age: (selectedPlayer?.currentAge || 25) + i,
        war,
        price: projectedPrice,
        change: ((projectedPrice - price) / price) * 100,
        isPeak: isPeakYear,
      };
    }).filter(Boolean);
  };

  const cardValues = showProjection ? projectCardValue() : null;
  const rec = cardValues ? (
    cardValues[0]?.change > 30 ? { l: "STRONG BUY", c: C.green } :
    cardValues[0]?.change > 10 ? { l: "BUY", c: "#22c55e" } :
    cardValues[0]?.change > -10 ? { l: "HOLD", c: C.accent } :
    { l: "SELL", c: "#ef4444" }
  ) : null;

  return (
    <div style={{display:"flex",flexDirection:"column",gap:14}}>
      <Panel title="CARD MARKETPLACE" sub="Project the future value of baseball cards using WAR trajectories">
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}>
          {/* Left: Player Search */}
          <div>
            <div style={{fontSize:10,fontWeight:700,color:C.muted,fontFamily:F,marginBottom:6}}>PLAYER</div>
            <div style={{position:"relative"}}>
              <input
                value={search}
                onChange={e => setSearch(e.target.value)}
                placeholder={selectedPlayer ? selectedPlayer.fullName : "Search player..."}
                style={{width:"100%",padding:"8px 12px",borderRadius:6,border:`1px solid ${C.border}`,background:"#fff",color:C.text,fontSize:12,fontFamily:F,outline:"none",boxSizing:"border-box"}}
              />
              {searchResults.length > 0 && (
                <div style={{position:"absolute",top:"100%",left:0,right:0,zIndex:100,background:"#fff",border:`1px solid ${C.border}`,borderRadius:6,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"}}>
                  {searchResults.map(p => (
                    <div key={p.id} onClick={() => selectPlayer(p)}
                      style={{padding:"8px 12px",cursor:"pointer",fontSize:11,fontFamily:F,borderBottom:`1px solid ${C.border}22`,color:C.text}}
                      onMouseOver={e=>e.currentTarget.style.background=C.hover}
                      onMouseOut={e=>e.currentTarget.style.background="transparent"}>
                      {p.fullName} <span style={{color:C.muted,fontSize:9}}>{posLabel(p.primaryPosition?.code)} · {p.currentTeam?.abbreviation||"FA"}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
            {loadingPlayer && <div style={{fontSize:10,color:C.muted,fontFamily:F,marginTop:6}}>Loading player data...</div>}
            {selectedPlayer && !loadingPlayer && (
              <div style={{marginTop:8,padding:"10px 12px",background:`${C.accent}08`,borderRadius:6,border:`1px solid ${C.accent}20`}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4}}>
                  <span style={{fontSize:13,fontWeight:700,color:C.text,fontFamily:F}}>{selectedPlayer.fullName}</span>
                  {selectedPlayer.fv && <FVBadge fv={selectedPlayer.fv}/>}
                </div>
                <div style={{fontSize:10,color:C.muted,fontFamily:F}}>
                  {posLabel(selectedPlayer.primaryPosition?.code)} · {selectedPlayer.currentTeam?.name||"FA"} · Age {selectedPlayer.currentAge}
                </div>
                {projection?.base && (
                  <div style={{marginTop:6,display:"flex",gap:12}}>
                    <div><span style={{fontSize:9,color:C.muted,fontFamily:F}}>PROJ WAR</span><div style={{fontSize:13,fontWeight:700,color:C.accent,fontFamily:F}}>{projection.base.baseWAR?.toFixed(1)}</div></div>
                    <div><span style={{fontSize:9,color:C.muted,fontFamily:F}}>PEAK AGE</span><div style={{fontSize:13,fontWeight:700,color:C.blue,fontFamily:F}}>{projection.base.peakAge||"—"}</div></div>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Right: Card Details */}
          <div>
            <div style={{fontSize:10,fontWeight:700,color:C.muted,fontFamily:F,marginBottom:6}}>CARD DETAILS</div>
            <div style={{display:"flex",flexDirection:"column",gap:8}}>
              <div>
                <div style={{fontSize:9,color:C.muted,fontFamily:F,marginBottom:3}}>CARD TYPE</div>
                <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                  {CARD_TYPES.map(t => (
                    <button key={t.k} onClick={() => setCardType(t.k)}
                      style={{padding:"4px 8px",borderRadius:4,border:`1px solid ${cardType===t.k?C.accent:C.border}`,background:cardType===t.k?`${C.accent}15`:"transparent",color:cardType===t.k?C.accent:C.muted,fontSize:9,fontFamily:F,cursor:"pointer",fontWeight:cardType===t.k?700:400}}>
                      {t.l}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <div style={{fontSize:9,color:C.muted,fontFamily:F,marginBottom:3}}>GRADE</div>
                <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                  {PSA_GRADES.map(g => (
                    <button key={g.k} onClick={() => setPsaGrade(g.k)}
                      style={{padding:"4px 8px",borderRadius:4,border:`1px solid ${psaGrade===g.k?C.blue:C.border}`,background:psaGrade===g.k?`${C.blue}15`:"transparent",color:psaGrade===g.k?C.blue:C.muted,fontSize:9,fontFamily:F,cursor:"pointer",fontWeight:psaGrade===g.k?700:400}}>
                      {g.l}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <div style={{fontSize:9,color:C.muted,fontFamily:F,marginBottom:3}}>PARALLEL / VARIATION</div>
                <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                  {PARALLELS.map(p => (
                    <button key={p.k} onClick={() => setParallel(p.k)}
                      style={{padding:"4px 8px",borderRadius:4,border:`1px solid ${parallel===p.k?C.purple:C.border}`,background:parallel===p.k?`${C.purple}15`:"transparent",color:parallel===p.k?C.purple:C.muted,fontSize:9,fontFamily:F,cursor:"pointer",fontWeight:parallel===p.k?700:400}}>
                      {p.l}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <div style={{fontSize:9,color:C.muted,fontFamily:F,marginBottom:3}}>CURRENT PRICE ($)</div>
                <input
                  type="number"
                  value={currentPrice}
                  onChange={e => setCurrentPrice(e.target.value)}
                  placeholder="e.g. 150"
                  style={{width:"100%",padding:"7px 10px",borderRadius:6,border:`1px solid ${C.border}`,background:"#fff",color:C.text,fontSize:12,fontFamily:F,outline:"none",boxSizing:"border-box"}}
                />
              </div>
              <button
                onClick={() => setShowProjection(true)}
                disabled={!selectedPlayer || !currentPrice}
                style={{padding:"8px 16px",borderRadius:6,border:"none",background:(!selectedPlayer||!currentPrice)?C.border:C.accent,color:"#fff",fontSize:11,fontWeight:700,fontFamily:F,cursor:(!selectedPlayer||!currentPrice)?"not-allowed":"pointer"}}>
                PROJECT VALUE
              </button>
            </div>
          </div>
        </div>

        {/* Projection Results */}
        {showProjection && cardValues && (
          <div style={{marginTop:16,borderTop:`1px solid ${C.border}`,paddingTop:16}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12}}>
              <div style={{fontSize:12,fontWeight:700,color:C.text,fontFamily:F}}>5-YEAR VALUE PROJECTION</div>
              {rec && <div style={{padding:"4px 12px",borderRadius:4,background:`${rec.c}20`,color:rec.c,fontSize:10,fontWeight:700,fontFamily:F}}>{rec.l}</div>}
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(6,1fr)",gap:8,marginBottom:16}}>
              {cardValues.map((v,i) => (
                <div key={i} style={{padding:"10px 8px",borderRadius:8,border:`1px solid ${v.isPeak?C.accent:C.border}`,background:v.isPeak?`${C.accent}08`:"transparent",textAlign:"center"}}>
                  {v.isPeak && <div style={{fontSize:7,fontWeight:700,color:C.accent,fontFamily:F,marginBottom:2}}>PEAK</div>}
                  <div style={{fontSize:9,color:C.muted,fontFamily:F}}>{v.year}</div>
                  <div style={{fontSize:9,color:C.muted,fontFamily:F,marginBottom:4}}>Age {v.age}</div>
                  <div style={{fontSize:14,fontWeight:700,color:C.text,fontFamily:F}}>${v.price < 1000 ? v.price.toFixed(0) : (v.price/1000).toFixed(1)+"k"}</div>
                  <div style={{fontSize:9,fontWeight:600,color:v.change>=0?C.green:"#ef4444",fontFamily:F}}>{v.change>=0?"+":""}{v.change.toFixed(0)}%</div>
                  <div style={{fontSize:8,color:C.muted,fontFamily:F,marginTop:2}}>{v.war.toFixed(1)} WAR</div>
                </div>
              ))}
            </div>
            <div style={{fontSize:9,color:C.muted,fontFamily:F,lineHeight:1.6,padding:"8px 12px",background:`${C.border}30`,borderRadius:6}}>
              ⚠️ Card value projections are speculative estimates based on WAR trajectory, player age curves, and market premiums. Not financial advice. Card markets are volatile and influenced by many factors beyond on-field performance.
            </div>
          </div>
        )}
      </Panel>
    </div>
  );
}

function MethodPanel() {
  return <div style={{display:"flex",flexDirection:"column",gap:14}}>
    <Panel title="DATA SOURCES">
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(200px,1fr))",gap:8}}>
        {[
          {n:"MLB Stats API",d:"Player search, career stats, MiLB rosters across all levels (ROK→AAA). Free, no auth.",c:C.blue,s:"LIVE"},
          {n:"FanGraphs FV",d:"Future Value grades for top 100+ prospects. Hardcoded lookup table, updated seasonally.",c:C.green,s:"STATIC"},
          {n:"Statcast/TrackMan",d:"Batted ball data: avg EV, max EV, barrel% for top prospects. Hardcoded from MiLB TrackMan.",c:C.purple,s:"STATIC"},
          {n:"Baseball Savant",d:"Statcast: xwOBA, barrel%, exit velocity, sprint speed. Full integration planned.",c:C.accent,s:"PLANNED"},
        ].map(s=><div key={s.n} style={{padding:"12px 14px",background:`${s.c}06`,border:`1px solid ${s.c}18`,borderRadius:8}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
            <span style={{fontSize:12,fontWeight:700,color:s.c,fontFamily:F}}>{s.n}</span>
            <span style={{fontSize:7,fontWeight:700,padding:"2px 5px",borderRadius:3,fontFamily:F,background:s.s==="LIVE"?`${C.green}20`:s.s==="STATIC"?`${C.blue}20`:`${C.yellow}20`,color:s.s==="LIVE"?C.green:s.s==="STATIC"?C.blue:C.yellow}}>{s.s}</span>
          </div>
          <p style={{margin:0,fontSize:10,color:C.dim,lineHeight:1.5,fontFamily:F}}>{s.d}</p>
        </div>)}
      </div>
    </Panel>
    <Panel title="FUTURE VALUE SCALE">
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(130px,1fr))",gap:6}}>
        {[70,65,60,55,50,45,40].map(fv=>{const s=getFVStyle(fv);return(
          <div key={fv} style={{padding:"10px 12px",borderRadius:6,border:`1px solid ${C.border}`}}>
            <div style={{marginBottom:6}}><FVBadge fv={fv}/></div>
            <div style={{fontSize:9,color:C.muted,fontFamily:F}}>
              {fv>=65?"Franchise player":fv>=60?"All-Star upside":fv>=55?"Above-avg regular":fv>=50?"Avg regular":fv>=45?"Solid backup":fv>=40?"Fringe MLB":"—"}
            </div>
          </div>
        );})}
      </div>
    </Panel>
    <Panel title="MINOR LEAGUE TRANSLATION">
      <p style={{fontSize:12,color:C.dim,lineHeight:1.8,fontFamily:F,margin:"0 0 12px"}}>
        MiLB stats are <span style={{color:C.text}}>not directly comparable</span> to MLB. A .300 hitter in A-ball is not a .300 MLB hitter.
        The system applies level-specific translation factors derived from historical promotion data:
      </p>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(140px,1fr))",gap:6}}>
        {LEVEL_ORDER.map(lvl=>{const t=LEVEL_TRANSLATION[lvl];return <div key={lvl} style={{padding:"10px 12px",background:`${LEVEL_COLORS[lvl]}08`,border:`1px solid ${LEVEL_COLORS[lvl]}20`,borderRadius:6}}>
          <div style={{fontSize:15,fontWeight:800,color:LEVEL_COLORS[lvl],fontFamily:F}}>{lvl}</div>
          <div style={{fontSize:10,color:C.dim,fontFamily:F,marginTop:4}}>{t.label}</div>
          <div style={{fontSize:10,color:C.muted,fontFamily:F,marginTop:2}}>Stat multiplier: <span style={{color:C.text,fontWeight:700}}>{t.factor}x</span></div>
          <div style={{fontSize:10,color:C.muted,fontFamily:F}}>Reliability: <span style={{color:C.text}}>{Math.round(t.reliability*100)}%</span></div>
        </div>;})}
      </div>
    </Panel>
    <Panel title="PROJECTION METHODOLOGY">
      <div style={{fontSize:12,color:C.dim,lineHeight:1.8,fontFamily:F}}>
        <h4 style={{color:C.accent,fontSize:13,margin:"0 0 4px"}}>PA-Weighted Marcel</h4>
        <p style={{margin:"0 0 12px"}}>3 most recent seasons weighted 5/4/3 with PA scaling and recency multiplier (2025 > 2024 > 2023). MiLB stats translated to MLB equivalents before weighting. Regression to league mean scales with sample size.</p>
        
        <h4 style={{color:C.blue,fontSize:13,margin:"0 0 4px"}}>Expected Stats (xwOBA)</h4>
        <p style={{margin:"0 0 12px"}}>For MLB players with Statcast data, expected wOBA (xwOBA) from Baseball Savant is used to identify unlucky BABIP seasons. Players whose xwOBA significantly exceeds actual performance get a positive adjustment (up to +15%).</p>
        
        <h4 style={{color:C.purple,fontSize:13,margin:"0 0 4px"}}>Batted Ball Quality</h4>
        <p style={{margin:"0 0 12px"}}>Exit velocity, max exit velocity, and barrel rate from Statcast inform projection adjustments. Elite barrel rates (10%+) can boost projections ~20%. Combines with xwOBA to capture true offensive talent.</p>
        
        <h4 style={{color:C.green,fontSize:13,margin:"0 0 4px"}}>Defense & Baserunning</h4>
        <p style={{margin:"0 0 12px"}}>Defense: OAA (Outs Above Average, 70% weight) + DRS (30% weight). Decays with age past position-specific defensive peaks. Baserunning: Sprint speed tiers for MLB players (+6 to -2 runs). MiLB players use SB/CS/G with efficiency penalties.</p>
        
        <h4 style={{color:C.orange,fontSize:13,margin:"0 0 4px"}}>WAR Construction</h4>
        <p style={{margin:"0 0 12px"}}>Batting runs (wRC+ × PA × 0.115) + defensive runs + baserunning runs + positional adjustment (FanGraphs scale: SS +7.5, CF +2.5, RF -5.0, 1B -12.5, DH -17.5) + replacement level, divided by 9.5 runs/win.</p>
        
        <h4 style={{color:"#ec4899",fontSize:13,margin:"0 0 4px"}}>FV Grade Benchmarks</h4>
        <p style={{margin:"0 0 12px"}}>Prospect FV grades (70/65/60/55/50/45/40) provide target WAR outcomes. For MiLB players, stats-based projections are blended with FV benchmarks weighted by sample size. Higher PA = more stat weight, lower PA = more FV weight.</p>
        
        <h4 style={{color:C.text,fontSize:13,margin:"0 0 4px"}}>Age-for-Level & Aging Curves</h4>
        <p style={{margin:"0 0 12px"}}>Young-for-level players get exponential boosts (4yr young = +35%). Post-peak aging is quadratic for offense, linear for defense. Position-specific peaks: SS 26, CF 27, corners 28, DH 29. Catchers age fastest.</p>
        
        <h4 style={{color:C.orange,fontSize:13,margin:"0 0 4px"}}>Value per Dollar (VpD)</h4>
        <p style={{margin:0}}>Cost efficiency on 1-100 scale: (Projected WAR / Salary in millions) × 10. Score of 50 = 0.5 WAR/$1M (average). Elite rookie contracts reach 80-99, overpaid veterans score 1-5. Identifies market inefficiencies.</p>
      </div>

    </Panel>
      </div>


}


// ── PLAYER OF THE DAY ────────────────────────────────────────────────────────
const POTD_POOL = [
  "Aaron Judge","Juan Soto","Shohei Ohtani","Mookie Betts","Gunnar Henderson",
  "Bobby Witt Jr.","Elly De La Cruz","Julio Rodriguez","Jackson Chourio","Corbin Carroll",
  "Ronald Acuña Jr.","Fernando Tatis Jr.","Corey Seager","Freddie Freeman","Bryce Harper",
  "Mike Trout","Yordan Alvarez","Kyle Tucker","Adley Rutschman","Cal Raleigh",
  "Riley Greene","Jackson Merrill","James Wood","Pete Crow-Armstrong","Roman Anthony",
  "Marcelo Mayer","Colson Montgomery","Junior Caminero","Jackson Holliday","Wyatt Langford",
  "Dylan Crews","Evan Carter","Andy Pages","Masyn Winn","Colt Keith",
  "Matt McLain","Maikel Garcia","Anthony Volpe","CJ Abrams","Zach Neto",
  "Jarren Duran","Steven Kwan","Kerry Carpenter","Michael Harris II","Bryson Stott",
  "Vladimir Guerrero Jr.","Rafael Devers","Jose Ramirez","Manny Machado","Alex Bregman",
  "Marcus Semien","Francisco Lindor","Trea Turner","Dansby Swanson","Bo Bichette",
  "Willy Adames","Matt Olson","Pete Alonso","Cody Bellinger","Kyle Schwarber",
  "Konnor Griffin","Kevin McGonigle","Samuel Basallo","Sebastian Walcott","Aidan Miller",
  "Max Clark","JJ Wetherholt","Colt Emerson","Carter Jensen","Nick Kurtz",
  "Paul Skenes","Roki Sasaki","Tarik Skubal","Corbin Burnes","Zack Wheeler",
  "Cole Ragans","Logan Webb","Garrett Crochet","Chris Sale","Dylan Cease",
  "Grayson Rodriguez","Hunter Brown","Jared Jones","Luis Gil","Tanner Bibee",
];

function getPlayerOfTheDay() {
  const now = new Date();
  const daysSinceEpoch = Math.floor(now.getTime() / 86400000);
  const idx = daysSinceEpoch % POTD_POOL.length;
  return POTD_POOL[idx];
}

function PlayerOfTheDay({onSelect}) {
  const [potdData, setPotdData] = useState(null);
  const [loading, setLoading] = useState(true);
  const name = getPlayerOfTheDay();

  useEffect(() => {
    setLoading(true);
    searchPlayers(name).then(async results => {
      if (!results[0]) { setLoading(false); return; }
      const p = results[0];
      try {
        const detail = await getPlayerStats(p.id);
        const player = detail || p;
        const isPitch = player.primaryPosition?.code === "1";
        const career = await getPlayerCareer(player.id, isPitch ? "pitching" : "hitting");
        const splits = isPitch
          ? career.filter(s => parseFloat(s.stat?.inningsPitched || 0) > 0)
          : career.filter(s => s.stat?.plateAppearances > 0);
        if (splits.length) {
          const base = isPitch
            ? projectPitcherFromSeasons(splits, player.currentAge, player.fullName, player.id)
            : projectFromSeasons(splits, player.currentAge, player.primaryPosition?.code, player.fullName, player.id);
          const fv = getPlayerFV(player.id, player.fullName);
          const cWAR = getCareerWAR(player.id, player.fullName);
          setPotdData({ player, base, fv, cWAR });
        }
      } catch {}
      setLoading(false);
    });
  }, [name]);

  return (
    <div style={{margin:"20px auto 0",maxWidth:400,padding:"18px 22px",background:`linear-gradient(135deg, ${C.navy}06, ${C.accent}04)`,border:`1px solid ${C.navy}18`,borderRadius:12,textAlign:"center"}}>
      <div style={{fontSize:8,fontWeight:700,letterSpacing:".12em",color:C.accent,fontFamily:F,textTransform:"uppercase",marginBottom:6}}>&#9733; Player of the Day &#9733;</div>
      {loading ? (
        <div style={{fontSize:11,color:C.muted,fontFamily:F,padding:8}}>Loading...</div>
      ) : potdData ? (
        <div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:8,marginBottom:8}}>
            <button onClick={()=>onSelect(potdData.player)}
              style={{background:"none",border:"none",cursor:"pointer",fontSize:18,fontWeight:800,color:C.navy,fontFamily:F,padding:0}}
              onMouseEnter={e=>e.target.style.color=C.accent}
              onMouseLeave={e=>e.target.style.color=C.navy}
            >{potdData.player.fullName}</button>
            {potdData.fv && <FVBadge fv={potdData.fv}/>}
          </div>
          <div style={{fontSize:10,color:C.muted,fontFamily:F,marginBottom:10}}>
            {posLabel(potdData.player.primaryPosition?.code)} &middot; {potdData.player.currentTeam?.name||"Free Agent"} &middot; Age {potdData.player.currentAge}
          </div>
          {potdData.base && (
            <div style={{display:"flex",justifyContent:"center",gap:12}}>
              {potdData.base.isPitcher ? <>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:18,fontWeight:800,color:potdData.base.era<=3.00?C.green:potdData.base.era<=3.80?C.blue:C.text,fontFamily:F}}>{potdData.base.era.toFixed(2)}</div>
                  <div style={{fontSize:7,color:C.muted,fontFamily:F,textTransform:"uppercase",letterSpacing:".08em",marginTop:1}}>Proj ERA</div>
                </div>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:18,fontWeight:800,color:potdData.base.k9>=10?C.green:potdData.base.k9>=8.5?C.blue:C.text,fontFamily:F}}>{potdData.base.k9.toFixed(1)}</div>
                  <div style={{fontSize:7,color:C.muted,fontFamily:F,textTransform:"uppercase",letterSpacing:".08em",marginTop:1}}>Proj K/9</div>
                </div>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:18,fontWeight:800,color:potdData.base.baseWAR>=4?C.green:potdData.base.baseWAR>=2?C.blue:C.text,fontFamily:F}}>{potdData.base.baseWAR.toFixed(1)}</div>
                  <div style={{fontSize:7,color:C.muted,fontFamily:F,textTransform:"uppercase",letterSpacing:".08em",marginTop:1}}>Proj WAR</div>
                </div>
              </> : <>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:18,fontWeight:800,color:potdData.base.ops>=.850?C.green:potdData.base.ops>=.720?C.blue:C.text,fontFamily:F}}>{potdData.base.ops.toFixed(3)}</div>
                  <div style={{fontSize:7,color:C.muted,fontFamily:F,textTransform:"uppercase",letterSpacing:".08em",marginTop:1}}>Proj OPS</div>
                </div>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:18,fontWeight:800,color:potdData.base.hr>=30?C.green:potdData.base.hr>=20?C.blue:C.text,fontFamily:F}}>{potdData.base.hr}</div>
                  <div style={{fontSize:7,color:C.muted,fontFamily:F,textTransform:"uppercase",letterSpacing:".08em",marginTop:1}}>Proj HR</div>
                </div>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:18,fontWeight:800,color:potdData.base.baseWAR>=4?C.green:potdData.base.baseWAR>=2?C.blue:C.text,fontFamily:F}}>{potdData.base.baseWAR.toFixed(1)}</div>
                  <div style={{fontSize:7,color:C.muted,fontFamily:F,textTransform:"uppercase",letterSpacing:".08em",marginTop:1}}>Proj WAR</div>
                </div>
              </>}
              {potdData.cWAR !== null && (
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:18,fontWeight:800,color:potdData.cWAR>=30?C.green:potdData.cWAR>=15?C.blue:C.purple,fontFamily:F}}>{potdData.cWAR.toFixed(1)}</div>
                  <div style={{fontSize:7,color:C.muted,fontFamily:F,textTransform:"uppercase",letterSpacing:".08em",marginTop:1}}>Career fWAR</div>
                </div>
              )}
            </div>
          )}
          <div style={{fontSize:9,color:C.muted,fontFamily:F,marginTop:10,cursor:"pointer"}} onClick={()=>onSelect(potdData.player)}>Click for full projections &rarr;</div>
        </div>
      ) : (
        <div style={{fontSize:11,color:C.muted,fontFamily:F}}>{name}</div>
      )}
    </div>
  );
}

// ── MAIN APP ─────────────────────────────────────────────────────────────────
const TABS=[
  {k:"player",l:"Player Projections"},
  {k:"leaders",l:"Leaderboard"},
  {k:"roster",l:"MLB & MiLB Rosters"},
  
  {k:"compare",l:"Player Comparison"},
  {k:"cost",l:"Value per Dollar"},
  {k:"cards",l:"Card Marketplace"},
  {k:"method",l:"Methodology"},
];

function ComparePanel({ onSelect }) {
  const [slots, setSlots] = useState([null, null, null]);
  const [searches, setSearches] = useState(["", "", ""]);
  const [results, setResults] = useState([[], [], []]);
  const [projections, setProjections] = useState([null, null, null]);
  const [loading, setLoading] = useState([false, false, false]);

  const searchPlayer = async (query, idx) => {
    const newSearches = [...searches];
    newSearches[idx] = query;
    setSearches(newSearches);
    if (query.length < 2) { const nr = [...results]; nr[idx] = []; setResults(nr); return; }
    try {
      const r = await fetch(`${API}/people/search?names=${encodeURIComponent(query)}&sportIds=1,11,12,13,14,16&hydrate=currentTeam,team,primaryPosition&limit=8`);
      const d = await r.json();
      const nr = [...results]; nr[idx] = (d.people || []).slice(0, 6); setResults(nr);
    } catch { }
  };

  const selectPlayer = async (player, idx) => {
    const fullPlayer = await getPlayerStats(player.id);
    const ns = [...slots]; ns[idx] = fullPlayer || player; setSlots(ns);
    console.log("Full player data:", fullPlayer);
    const nr = [...results]; nr[idx] = []; setResults(nr);
    const nsr = [...searches]; nsr[idx] = ""; setSearches(nsr);
    const nl = [...loading]; nl[idx] = true; setLoading(nl);

    try {
      const isPitcher = (fullPlayer || player).primaryPosition?.code === "1";
      const career = await getPlayerCareer((fullPlayer || player).id, isPitcher ? "pitching" : "hitting");
      let base, forward;
      if (isPitcher) {
        base = projectPitcherFromSeasons(career.filter(s => parseFloat(s.stat?.inningsPitched || 0) > 0), (fullPlayer || player).currentAge, (fullPlayer || player).fullName, (fullPlayer || player).id);
        forward = base ? projectPitcherForward(base, (fullPlayer || player).currentAge) : [];
      } else {
        const splits = career.filter(s => s.stat?.plateAppearances > 0);
        base = projectFromSeasons(splits, (fullPlayer || player).currentAge, (fullPlayer || player).primaryPosition?.code, (fullPlayer || player).fullName, (fullPlayer || player).id);
        forward = base ? projectForward(base, (fullPlayer || player).currentAge, (fullPlayer || player).primaryPosition?.code) : [];
      }
      const np = [...projections]; np[idx] = { base, forward, isPitcher }; setProjections(np);
    } catch { }
    const nl2 = [...loading]; nl2[idx] = false; setLoading(nl2);
  };

  const removePlayer = (idx) => {
    const ns = [...slots]; ns[idx] = null; setSlots(ns);
    const np = [...projections]; np[idx] = null; setProjections(np);
  };

  const COLORS = ["#c8102e", "#1a3668", "#059669"];
  const filledSlots = slots.filter(Boolean);
  const allForward = projections.filter(Boolean).map(p => p.forward);
  const maxYears = Math.max(...allForward.map(f => f.length), 0);

  // Build chart data
  const chartData = [];
  for (let y = 0; y < Math.min(maxYears, 8); y++) {
    const point = {};
    slots.forEach((s, i) => {
      if (s && projections[i]?.forward?.[y]) {
        const f = projections[i].forward[y];
        point.season = point.season || ("'" + String(2026 + y).slice(2));
        point[`war${i}`] = f.war;
        point[`name${i}`] = s.fullName;
      }
    });
    if (Object.keys(point).length > 1) chartData.push(point);
  }

  return (
    <div>
      <Panel title="PLAYER COMPARISON" sub="Compare up to 3 players side-by-side with projected WAR curves.">
        <div style={{display:"flex",gap:12,flexWrap:"wrap",marginBottom:16}}>
          {[0,1,2].map(idx => (
            <div key={idx} style={{flex:"1 1 200px",minWidth:180}}>
              {slots[idx] ? (
                <div style={{padding:12,borderRadius:8,border:`2px solid ${COLORS[idx]}`,background:`${COLORS[idx]}08`}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div>
                      <div style={{fontSize:14,fontWeight:700,color:C.text,fontFamily:F}}>{slots[idx].fullName}</div>
                      <div style={{fontSize:10,color:C.muted,fontFamily:F}}>
                        {posLabel(slots[idx].primaryPosition?.code)} &middot; {slots[idx].currentTeam?.name || "FA"} &middot; Age {slots[idx].currentAge}
                      </div>
                    </div>
                    <button onClick={()=>removePlayer(idx)} style={{background:"none",border:"none",cursor:"pointer",fontSize:16,color:C.muted,padding:4}}>&times;</button>
                  </div>
                  {loading[idx] && <div style={{fontSize:10,color:C.muted,fontFamily:F,marginTop:6}}>Loading projections...</div>}
                  {projections[idx]?.base && (
                    <div style={{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"}}>
                      {projections[idx].isPitcher ? <>
                        <div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:800,color:COLORS[idx],fontFamily:F}}>{projections[idx].base.era?.toFixed(2)}</div><div style={{fontSize:7,color:C.muted,fontFamily:F}}>ERA</div></div>
                        <div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:800,color:COLORS[idx],fontFamily:F}}>{projections[idx].base.k9?.toFixed(1)}</div><div style={{fontSize:7,color:C.muted,fontFamily:F}}>K/9</div></div>
                        <div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:800,color:COLORS[idx],fontFamily:F}}>{projections[idx].base.baseWAR?.toFixed(1)}</div><div style={{fontSize:7,color:C.muted,fontFamily:F}}>WAR</div></div>
                      </> : <>
                        <div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:800,color:COLORS[idx],fontFamily:F}}>{projections[idx].base.ops?.toFixed(3)}</div><div style={{fontSize:7,color:C.muted,fontFamily:F}}>OPS</div></div>
                        <div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:800,color:COLORS[idx],fontFamily:F}}>{projections[idx].base.hr}</div><div style={{fontSize:7,color:C.muted,fontFamily:F}}>HR</div></div>
                        <div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:800,color:COLORS[idx],fontFamily:F}}>{projections[idx].base.baseWAR?.toFixed(1)}</div><div style={{fontSize:7,color:C.muted,fontFamily:F}}>WAR</div></div>
                      </>}
                    </div>
                  )}
                </div>
              ) : (
                <div style={{padding:12,borderRadius:8,border:`2px dashed ${C.border}`,background:`${C.panel}`}}>
                  <div style={{fontSize:10,color:C.muted,fontFamily:F,marginBottom:6}}>Player {idx + 1}</div>
                  <input
                    value={searches[idx]}
                    onChange={e => searchPlayer(e.target.value, idx)}
                    placeholder="Search player..."
                    style={{width:"100%",padding:"6px 10px",borderRadius:6,border:`1px solid ${C.border}`,background:"#fff",color:C.text,fontSize:11,fontFamily:F,outline:"none",boxSizing:"border-box"}}
                  />
                  {results[idx].length > 0 && (
                    <div style={{marginTop:4,maxHeight:180,overflowY:"auto",borderRadius:6,border:`1px solid ${C.border}`,background:"#fff"}}>
                      {results[idx].map(p => (
                        <div key={p.id} onClick={() => selectPlayer(p, idx)}
                          style={{padding:"6px 10px",cursor:"pointer",fontSize:11,fontFamily:F,borderBottom:`1px solid ${C.border}22`,color:C.text}}
                          onMouseOver={e=>e.currentTarget.style.background=C.hover}
                          onMouseOut={e=>e.currentTarget.style.background="transparent"}>
                          {p.fullName} <span style={{color:C.muted,fontSize:9}}>{posLabel(p.primaryPosition?.code)} &middot; {p.currentTeam?.abbreviation || "FA"}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
        </div>
      </Panel>

      {chartData.length > 0 && (
        <Panel title="PROJECTED WAR COMPARISON" sub="Side-by-side WAR trajectory over the next 8 seasons.">
          <ResponsiveContainer width="100%" height={300}>
            <ComposedChart data={chartData} margin={{top:10,right:20,left:0,bottom:0}}>
              <CartesianGrid strokeDasharray="3 3" stroke={C.grid}/>
              <XAxis dataKey="season" stroke={C.muted} fontSize={10} fontFamily={F}/>
              <YAxis stroke={C.muted} fontSize={10} fontFamily={F}/>
              <Tooltip content={({active,payload,label}) => {
                if (!active || !payload?.length) return null;
                return <div style={{background:"#fff",border:`1px solid ${C.border}`,borderRadius:8,padding:"8px 12px",boxShadow:"0 4px 12px rgba(0,0,0,.1)"}}>
                  <div style={{fontSize:10,color:C.muted,fontFamily:F,marginBottom:4}}>Season {label}</div>
                  {payload.map((p,i) => <div key={i} style={{fontSize:11,color:p.color,fontFamily:F}}>{p.name}: <strong>{p.value?.toFixed(1)}</strong> WAR</div>)}
                </div>;
              }}/>
              <ReferenceLine y={0} stroke={C.muted} strokeDasharray="5 5"/>
              <ReferenceLine y={2} stroke={C.green} strokeDasharray="3 3" strokeOpacity={.3}/>
              {slots.map((s, i) => s && projections[i] ? (
                <Line key={i} type="monotone" dataKey={`war${i}`} name={s.fullName} stroke={COLORS[i]} strokeWidth={2.5} dot={{fill:COLORS[i],r:4}} activeDot={{r:6}}/>
              ) : null)}
            </ComposedChart>
          </ResponsiveContainer>
        </Panel>
      )}

      {filledSlots.length >= 2 && projections.filter(Boolean).length >= 2 && (
        <Panel title="STAT COMPARISON" sub="Projected season stats side-by-side.">
          <div className="via-table-wrap" style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,fontFamily:F}}>
              <thead><tr>
                <th style={{padding:"6px 8px",borderBottom:`2px solid ${C.border}`,textAlign:"left",color:C.muted,fontWeight:700,fontSize:9}}>Stat</th>
                {slots.map((s, i) => s ? <th key={i} style={{padding:"6px 8px",borderBottom:`2px solid ${COLORS[i]}`,textAlign:"right",color:COLORS[i],fontWeight:700,fontSize:9}}>{s.fullName.split(" ").pop()}</th> : null)}
              </tr></thead>
              <tbody>
                {(() => {
                  const anyPitcher = projections.some(p => p?.isPitcher);
                  const anyHitter = projections.some(p => p && !p.isPitcher);
                  const rows = [];
                  if (anyHitter) {
                    [{k:"ops",l:"OPS",fmt:v=>v?.toFixed(3)},{k:"wRCPlus",l:"wRC+",fmt:v=>v},{k:"hr",l:"HR",fmt:v=>v},{k:"avg",l:"AVG",fmt:v=>v?.toFixed(3)},{k:"obp",l:"OBP",fmt:v=>v?.toFixed(3)},{k:"slg",l:"SLG",fmt:v=>v?.toFixed(3)},{k:"baseWAR",l:"Proj WAR",fmt:v=>v?.toFixed(1)}].forEach(stat => {
                      rows.push(<tr key={stat.k} style={{borderBottom:`1px solid ${C.border}22`}}>
                        <td style={{padding:"5px 8px",fontWeight:600}}>{stat.l}</td>
                        {slots.map((s, i) => s ? <td key={i} style={{padding:"5px 8px",textAlign:"right",fontWeight:600,color:COLORS[i]}}>{projections[i]?.base && !projections[i]?.isPitcher ? stat.fmt(projections[i].base[stat.k]) ?? "—" : "—"}</td> : null)}
                      </tr>);
                    });
                  }
                  if (anyPitcher) {
                    [{k:"era",l:"ERA",fmt:v=>v?.toFixed(2)},{k:"fip",l:"FIP",fmt:v=>v?.toFixed(2)},{k:"whip",l:"WHIP",fmt:v=>v?.toFixed(2)},{k:"k9",l:"K/9",fmt:v=>v?.toFixed(1)},{k:"ip",l:"IP",fmt:v=>v},{k:"baseWAR",l:"Proj WAR",fmt:v=>v?.toFixed(1)}].forEach(stat => {
                      rows.push(<tr key={"p_"+stat.k} style={{borderBottom:`1px solid ${C.border}22`}}>
                        <td style={{padding:"5px 8px",fontWeight:600}}>{stat.l}</td>
                        {slots.map((s, i) => s ? <td key={i} style={{padding:"5px 8px",textAlign:"right",fontWeight:600,color:COLORS[i]}}>{projections[i]?.base && projections[i]?.isPitcher ? stat.fmt(projections[i].base[stat.k]) ?? "—" : "—"}</td> : null)}
                      </tr>);
                    });
                  }
                  // 10yr WAR for all
                  rows.push(<tr key="cumwar" style={{borderBottom:`1px solid ${C.border}22`,background:`${C.accent}05`}}>
                    <td style={{padding:"5px 8px",fontWeight:700}}>10yr WAR</td>
                    {slots.map((s, i) => s ? <td key={i} style={{padding:"5px 8px",textAlign:"right",fontWeight:800,color:COLORS[i]}}>{projections[i]?.forward ? projections[i].forward.reduce((sum, d) => sum + Math.max(0, d.war), 0).toFixed(1) : "—"}</td> : null)}
                  </tr>);
                  // Career fWAR
                  rows.push(<tr key="cfwar" style={{borderBottom:`1px solid ${C.border}22`}}>
                    <td style={{padding:"5px 8px",fontWeight:600}}>Career fWAR</td>
                    {slots.map((s, i) => s ? <td key={i} style={{padding:"5px 8px",textAlign:"right",fontWeight:600,color:COLORS[i]}}>{(() => { const w = getCareerWAR(s.id, s.fullName); return w !== null ? w.toFixed(1) : "—"; })()}</td> : null)}
                  </tr>);
                  return rows;
                })()}
              </tbody>
            </table>
          </div>
        </Panel>
      )}
    </div>
  );
}

export default function App() {
  const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth <= 768);
    window.addEventListener("resize", handleResize);
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  const [tab,setTab]=useState("player");
  const [selPlayer,setSelPlayer]=useState(null);
  const [detail,setDetail]=useState(null);
  const [lp,setLp]=useState(false);

  const pick=useCallback(p=>{setSelPlayer(p);setLp(true);setTab("player");getPlayerStats(p.id).then(d=>{setDetail(d||p);setLp(false);});},[]);

  const goHome = useCallback(()=>{setSelPlayer(null);setDetail(null);setLp(false);setTab("player");},[]);

  return (
    <div style={{minHeight:"100vh",background:C.bg,color:C.text,fontFamily:F}}>
      <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700;800&family=Changa+One&display=swap" rel="stylesheet"/>
      {/* Header */}
      <div className="via-header" style={{padding:"14px 24px 0",borderBottom:`2px solid ${C.navy}`,background:"linear-gradient(180deg, #ffffff 0%, #f9f5ed 100%)"}}>
        <div className="via-header-inner" style={{display:"flex",alignItems:"center",gap:14,marginBottom:12,flexWrap:"wrap"}}>
          <div onClick={goHome} style={{cursor:"pointer",userSelect:"none"}}>
            <div style={{display:"flex",alignItems:"baseline",gap:6}}>
              <span className="via-title" style={{fontFamily:"'Changa One', cursive",fontSize:38,className:undefined,fontWeight:400,color:C.navy,lineHeight:1,letterSpacing:"-0.02em",textShadow:`2px 2px 0 ${C.accent}30`}}>VIAcast</span>
              <span style={{width:8,height:8,borderRadius:"50%",background:C.accent,display:"inline-block",marginBottom:4}}/>
            </div>
            <p style={{margin:"1px 0 0 2px",fontSize:11,fontWeight:700,color:C.navy,letterSpacing:".06em",fontFamily:F,textTransform:"uppercase"}}>Baseball Projection Engine</p>
            <p style={{margin:"2px 0 0 2px",fontSize:9,color:C.muted,letterSpacing:".04em",fontFamily:F}}>Data-driven MLB &amp; MiLB forecasting</p>
          </div>
          {!isMobile&&<div className="via-search" style={{marginLeft:"auto"}}><PlayerSearch onSelect={pick}/></div>}
        </div>
        <div className="via-tabs" style={{display:"flex",gap:isMobile?0:2,flexWrap:"nowrap",overflowX:"auto",WebkitOverflowScrolling:"touch"}}>
          {TABS.map(t=><button key={t.k} onClick={()=>setTab(t.k)} style={{
            padding:"7px 16px",border:"none",cursor:"pointer",fontSize:11,fontWeight:tab===t.k?700:500,fontFamily:F,
            background:tab===t.k?C.panel:"transparent",color:tab===t.k?C.navy:C.muted,
            borderRadius:"6px 6px 0 0",borderBottom:tab===t.k?`2px solid ${C.accent}`:"2px solid transparent",
          }}>{t.l}</button>)}
        </div>
      {isMobile&&<div style={{display:"flex",justifyContent:"center",padding:"10px 16px",background:"#f9f5ed"}}><div style={{width:"100%",maxWidth:400}}><PlayerSearch onSelect={pick}/></div></div>}
      </div>
      {/* Content */}
      <div className="via-content" style={{padding:"16px 24px 40px"}}>
        {tab==="player"&&<div>
          {!selPlayer&&!lp&&<Panel style={{textAlign:"center",padding:50}}>
            <div style={{fontSize:44,marginBottom:12}}>&#9918;</div>
            <h3 style={{margin:0,fontSize:16,color:C.text,fontFamily:F}}>Search any MLB or minor league player</h3>
            <p style={{margin:"6px auto 0",fontSize:12,color:C.muted,fontFamily:F,maxWidth:520,lineHeight:1.6}}>
              Covers all levels from Rookie ball through the majors. MiLB stats are translated using level-specific conversion factors before projection. Top prospects include FV grades and batted ball data.
            </p>
            <PlayerOfTheDay onSelect={pick}/>
            <div style={{marginTop:20,display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"}}>
              {["Konnor Griffin","Aidan Miller","Juan Soto","Gunnar Henderson","Kevin McGonigle","Samuel Basallo"].map(n=>
                <button key={n} onClick={()=>searchPlayers(n).then(r=>{if(r[0])pick(r[0]);})}
                  style={{padding:"5px 12px",borderRadius:6,border:`1px solid ${C.border}`,background:"transparent",color:C.dim,fontSize:11,fontFamily:F,cursor:"pointer"}}
                  onMouseEnter={e=>{e.target.style.borderColor=C.accent;e.target.style.color=C.accent;}}
                  onMouseLeave={e=>{e.target.style.borderColor=C.border;e.target.style.color=C.dim;}}
                >{n}</button>
              )}
            </div>
          </Panel>}
          {lp&&<Spinner msg="Pulling career data..."/>}
          {selPlayer&&!lp&&detail&&<PlayerCard player={detail}/>}
        </div>}
        {tab==="leaders"&&<Leaderboard onSelect={pick}/>}
        {tab==="roster"&&<RosterBrowser onSelect={pick}/>}

        {tab==="compare"&&<ComparePanel onSelect={pick}/>}
        {tab==="cost"&&<VpDPanel/>}
        {tab==="cards"&&<CardMarketplace onSelect={pick}/>}
        {tab==="method"&&<MethodPanel/>}
      </div>
      <div className="via-footer" style={{padding:"12px 24px",borderTop:`2px solid ${C.navy}`,background:"#f9f5ed",display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:8}}>
        <span style={{fontSize:8,color:C.muted,fontFamily:F}}>VIAcast v2.1 VIAcast &middot; Data: MLB Stats APImiddot; Data: MLB Stats API &middot; FV: FanGraphs/ESPN consensus &middot; No affiliation with MLB</span>
        <span style={{fontSize:8,color:C.muted,fontFamily:F}}>Methodology: Marcel (Tango) + level translation + Statcast batted ball adjustments</span>
        <span style={{fontSize:8,color:C.muted,fontFamily:F}}>Questions or inquiries? <a href="mailto:trevanvia@gmail.com" style={{color:C.accent,textDecoration:"none"}}>trevanvia@gmail.com</a></span>
      </div>
    </div>
  );
}